name: Deploy to Sakura Server (FreeBSD)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy-freebsd:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Prepare deployment files
      run: |
        echo "ðŸŽ¯ Preparing files for FreeBSD deployment..."
        
        # é–‹ç™ºç”¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é™¤å¤–
        rm -f AGENT.md deploy-server.sh webhook-deploy.php test_*.sh *.yml 2>/dev/null || true
        rm -rf .github temp_workflows 2>/dev/null || true
        
        # ãƒ‡ãƒ—ãƒ­ã‚¤ç”¨ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆ
        echo "ðŸ“¦ Files to deploy:"
        find . -maxdepth 1 -type f \( -name "*.html" -o -name "*.css" -o -name "*.js" -o -name "README.md" -o -name "*DEPLOY*.md" -o -name "GITHUB_ACTIONS.md" \) -exec ls -la {} \;
        
    - name: Deploy to FreeBSD Sakura Server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: sogoodsnet.sakura.ne.jp
        username: sogoodsnet
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        timeout: 60s
        command_timeout: 120s
        script: |
          # FreeBSDç”¨ã®ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆsh/cshäº’æ›ï¼‰
          echo "ðŸš€ FreeBSD Sakura Server Deployment Started"
          echo "Current shell: $SHELL"
          echo "Current user: `whoami`"
          echo "Current directory: `pwd`"
          
          # å¤‰æ•°è¨­å®šï¼ˆFreeBSD shäº’æ›ï¼‰
          set DEPLOY_PATH = "/home/sogoodsnet/www"
          set BACKUP_DIR = "/home/sogoodsnet/backup"
          set TIMESTAMP = "`date +%Y%m%d-%H%M%S`"
          set BACKUP_PATH = "$BACKUP_DIR/sogoods-backup-$TIMESTAMP"
          
          echo "ðŸ“‚ Deploy path: $DEPLOY_PATH"
          echo "ðŸ’¾ Backup path: $BACKUP_PATH"
          
          # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ
          if (! -d "$BACKUP_DIR") then
            echo "Creating backup directory..."
            mkdir -p "$BACKUP_DIR"
          endif
          
          # æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
          if (-d "$DEPLOY_PATH") then
            if ("`ls -A $DEPLOY_PATH`" != "") then
              echo "ðŸ“¦ Creating backup..."
              mkdir -p "$BACKUP_PATH"
              cp -r "$DEPLOY_PATH"/* "$BACKUP_PATH"/ >& /dev/null
              echo "âœ… Backup created at: $BACKUP_PATH"
            endif
          endif
          
          # ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ
          mkdir -p "$DEPLOY_PATH"
          cd "$DEPLOY_PATH"
          
          # Gitè¨­å®šç¢ºèª
          if (! -x "`which git`") then
            echo "âŒ Git not found, using manual file transfer"
            exit 1
          endif
          
          # Gitãƒªãƒã‚¸ãƒˆãƒªã®åˆæœŸåŒ–
          if (! -d ".git") then
            echo "ðŸ”„ Initializing git repository..."
            git init
            git remote add origin https://github.com/sogoodsnet/sogoods.net-www.git >& /dev/null || echo "Remote already exists"
          endif
          
          # æœ€æ–°ã‚³ãƒ¼ãƒ‰ã®å–å¾—ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå¯¾ç­–ï¼‰
          echo "ðŸ“¥ Fetching latest code..."
          git config --local http.timeout 30
          git config --local http.lowSpeedLimit 1000
          git config --local http.lowSpeedTime 10
          
          git fetch --depth=1 origin main >& /dev/null || echo "Fetch with depth failed, trying full fetch"
          git reset --hard origin/main >& /dev/null || echo "Reset failed, continuing"
          
          # ä¸è¦ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤
          echo "ðŸ§¹ Cleaning up..."
          rm -rf .git .github AGENT.md deploy-server.sh webhook-deploy.php temp_workflows test_*.sh *.yml >& /dev/null
          
          # ãƒ•ã‚¡ã‚¤ãƒ«æ¨©é™ã®è¨­å®š
          echo "ðŸ”§ Setting permissions..."
          find . -name "*.html" -exec chmod 644 {} \; >& /dev/null
          find . -name "*.css" -exec chmod 644 {} \; >& /dev/null
          find . -name "*.js" -exec chmod 644 {} \; >& /dev/null
          find . -name "*.md" -exec chmod 644 {} \; >& /dev/null
          find . -type d -exec chmod 755 {} \; >& /dev/null
          
          # çµæžœç¢ºèª
          echo "ðŸ“‹ Deployed files:"
          ls -la
          
          echo "âœ… FreeBSD deployment completed!"
          echo "ðŸŒ Site available at: https://sogoodsnet.sakura.ne.jp/"
          
    - name: Alternative Deployment (Manual)
      if: failure()
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: sogoodsnet.sakura.ne.jp
        username: sogoodsnet
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        timeout: 30s
        script: |
          echo "ðŸ”„ Alternative deployment method"
          
          # åŸºæœ¬çš„ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
          mkdir -p /home/sogoodsnet/www
          mkdir -p /home/sogoodsnet/backup
          
          cd /home/sogoodsnet/www
          
          # æ‰‹å‹•ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆGitä½¿ã‚ãªã„ï¼‰
          echo "ðŸ“¥ Manual file download..."
          
          # curlã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å€‹åˆ¥ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          curl -s -o index.html https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/index.html || echo "index.html download failed"
          curl -s -o about.html https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/about.html || echo "about.html download failed"
          curl -s -o style.css https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/style.css || echo "style.css download failed"
          
          # æ¨©é™è¨­å®š
          chmod 644 *.html *.css >& /dev/null
          chmod 755 . >& /dev/null
          
          echo "ðŸ“‹ Alternative deployment files:"
          ls -la
          
          echo "âœ… Alternative deployment completed"
          
    - name: Deployment Summary
      if: always()
      run: |
        echo "## ðŸŒ¸ FreeBSD Sakura Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.deploy-freebsd.outcome }}" == "success" ]; then
          echo "- **Status**: âœ… Success (Primary Method)" >> $GITHUB_STEP_SUMMARY
          echo "- **Method**: Git-based deployment" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ steps.alternative-deployment.outcome }}" == "success" ]; then
          echo "- **Status**: âœ… Success (Alternative Method)" >> $GITHUB_STEP_SUMMARY
          echo "- **Method**: Manual file download" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **Status**: âŒ Both methods failed" >> $GITHUB_STEP_SUMMARY
          echo "- **Check**: FreeBSD shell compatibility and network access" >> $GITHUB_STEP_SUMMARY
        fi
        echo "- **Server**: FreeBSD on Sakura" >> $GITHUB_STEP_SUMMARY
        echo "- **URL**: https://sogoodsnet.sakura.ne.jp/" >> $GITHUB_STEP_SUMMARY