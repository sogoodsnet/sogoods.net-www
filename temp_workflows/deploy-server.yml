name: Deploy to Custom Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      server_host:
        description: 'Server hostname or IP'
        required: false
        default: 'your-server.com'
      deploy_path:
        description: 'Deployment path on server'
        required: false
        default: '/var/www/html/sogoods'

jobs:
  deploy-to-server:
    runs-on: ubuntu-latest
    # ã“ã®ã‚¸ãƒ§ãƒ–ã¯SecretãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿å®Ÿè¡Œ
    if: ${{ secrets.SERVER_HOST != '' }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Prepare deployment files
      run: |
        echo "ðŸŽ¯ Preparing files for server deployment..."
        
        # é–‹ç™ºç”¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é™¤å¤–
        rm -f AGENT.md deploy-server.sh webhook-deploy.php 2>/dev/null || true
        rm -rf .github 2>/dev/null || true
        
        # ãƒ‡ãƒ—ãƒ­ã‚¤ç”¨ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆ
        echo "ðŸ“¦ Files to deploy:"
        find . -type f \( -name "*.html" -o -name "*.css" -o -name "*.js" -o -name "*.md" \) -exec ls -la {} \;
        
    - name: Deploy via SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST || github.event.inputs.server_host }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          echo "ðŸš€ Starting deployment on server..."
          
          # ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
          DEPLOY_PATH="${{ secrets.DEPLOY_PATH || github.event.inputs.deploy_path || '/var/www/html/sogoods' }}"
          BACKUP_PATH="/tmp/sogoods-backup-$(date +%Y%m%d-%H%M%S)"
          
          echo "ðŸ“‚ Deploy path: $DEPLOY_PATH"
          echo "ðŸ’¾ Backup path: $BACKUP_PATH"
          
          # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ä½œæˆ
          if [ -d "$DEPLOY_PATH" ]; then
            echo "ðŸ“¦ Creating backup..."
            mkdir -p "$BACKUP_PATH"
            cp -r "$DEPLOY_PATH"/* "$BACKUP_PATH/" 2>/dev/null || true
          fi
          
          # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æº–å‚™
          mkdir -p "$DEPLOY_PATH"
          cd "$DEPLOY_PATH"
          
          # Git repository setup
          if [ ! -d ".git" ]; then
            echo "ðŸ”„ Initializing git repository..."
            git init
            git remote add origin https://github.com/sogoodsnet/sogoods.net-www.git
          fi
          
          # æœ€æ–°ã‚³ãƒ¼ãƒ‰ã®å–å¾—
          echo "ðŸ“¥ Fetching latest code..."
          git fetch origin main
          git reset --hard origin/main
          
          # ä¸è¦ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤
          echo "ðŸ§¹ Cleaning up..."
          rm -rf .git .github AGENT.md deploy-server.sh webhook-deploy.php 2>/dev/null || true
          
          # ãƒ•ã‚¡ã‚¤ãƒ«æ¨©é™ã®è¨­å®š
          echo "ðŸ”§ Setting file permissions..."
          find . -type f -name "*.html" -exec chmod 644 {} \;
          find . -type f -name "*.css" -exec chmod 644 {} \;
          find . -type f -name "*.js" -exec chmod 644 {} \;
          find . -type d -exec chmod 755 {} \;
          
          # Webã‚µãƒ¼ãƒãƒ¼ã®å†èµ·å‹•ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ï¼‰
          echo "ðŸ”„ Reloading web server..."
          sudo systemctl reload nginx 2>/dev/null || sudo systemctl reload apache2 2>/dev/null || echo "Web server reload skipped"
          
          echo "âœ… Deployment completed successfully!"
          echo "ðŸŒ Site should be available at your domain"
          
    - name: Deploy via SCP (Fallback)
      if: failure()
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        source: "*.html,*.css,*.js,README.md"
        target: ${{ secrets.DEPLOY_PATH || '/var/www/html/sogoods' }}
        
  notify-deployment:
    runs-on: ubuntu-latest
    needs: deploy-to-server
    if: always()
    
    steps:
    - name: Deployment Summary
      run: |
        echo "## ðŸš€ Server Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.deploy-to-server.result }}" == "success" ]; then
          echo "- **Status**: âœ… Success" >> $GITHUB_STEP_SUMMARY
          echo "- **Server**: ${{ secrets.SERVER_HOST || 'Custom Server' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deploy Time**: $(date)" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **Status**: âŒ Failed or Skipped" >> $GITHUB_STEP_SUMMARY
          echo "- **Reason**: Missing server configuration secrets" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”§ Required Secrets for Server Deployment:" >> $GITHUB_STEP_SUMMARY
        echo "- \`SERVER_HOST\`: Server hostname or IP" >> $GITHUB_STEP_SUMMARY
        echo "- \`SERVER_USER\`: SSH username" >> $GITHUB_STEP_SUMMARY
        echo "- \`SERVER_SSH_KEY\`: SSH private key" >> $GITHUB_STEP_SUMMARY
        echo "- \`DEPLOY_PATH\`: Deployment path (optional)" >> $GITHUB_STEP_SUMMARY