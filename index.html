<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>sogoods.net - Faithful Recreation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Times New Roman', serif;
            background: #f5f5f5;
            color: #000;
            line-height: 1.4;
            overflow-x: hidden;
        }

        /* メインコンテナ - 3カラムレイアウト（端末高さ100%対応） */
        .main-container {
            display: grid;
            grid-template-columns: 280px 1fr 280px;
            height: 100vh;
            max-height: none;
            min-height: 100vh;
            background: #f5f5f5;
            position: relative;
            overflow: hidden;
        }

        /* 左カラム - テキストエリア */
        .left-column {
            background: #f5f5f5;
            padding: 40px 20px 20px 20px;
            position: relative;
            overflow-y: auto;
            height: 100%;
        }

        /* ロゴエリア */
        .logo {
            width: 110px;
            height: 80px;
            margin-bottom: 30px;
            background: transparent;
            color: #000;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            font-family: Arial, sans-serif;
            font-size: 24px;
            font-weight: 900;
            letter-spacing: -1px;
        }
        
        .logo img {
            width: auto;
            height: auto;
            max-width: 110px;
            max-height: 80px;
            object-fit: contain;
        }

        /* SOGOODS.NETテキスト - 位置を少し下に */
        .extr-text {
            font-size: 48px;
            font-weight: 900;
            color: #000;
            margin: 35px 0 20px 0; /* 上マージンを15px→35px、下マージン20pxに変更 */
            font-family: Arial, sans-serif;
            letter-spacing: -4px;
            line-height: 0.8;
            text-transform: uppercase;
            word-break: break-all;
        }

        /* メニューロゴエリア */
        .menu-logos {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 25px;
            padding: 0;
        }

        /* メニューボタン共通スタイル */
        .menu-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
            text-decoration: none;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
            font-family: Arial, sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
            border: none;
            cursor: pointer;
        }

        .menu-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.5);
            background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%);
        }

        .menu-btn:active {
            transform: translateY(0);
        }

        /* MAPS画像ボタンのスタイル - クリーンで透過ロゴに最適 */
        .maps-img-btn {
            display: inline-block;
            padding: 2px;
            background: none;
            border: none;
            transition: all 0.3s ease;
            text-decoration: none;
            opacity: 0.8;
        }

        .maps-img-btn:hover {
            transform: translateY(-2px) scale(1.05);
            opacity: 1;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.15));
        }

        .maps-img-btn:active {
            transform: translateY(0);
        }

        .maps-img {
            display: block;
            width: auto;
            height: 32px; /* 適切なサイズに調整 */
            max-width: 100%;
            object-fit: contain;
        }

        /* 旧CSSボタンスタイル（予備） */
        .btn-icon {
            font-size: 14px;
            display: flex;
            align-items: center;
        }

        .btn-text {
            font-size: 10px;
            font-weight: bold;
        }

        /* 左側のテキストブロック - フォントサイズを少し大きく */
        .text-content {
            font-size: 12px;
            line-height: 1.3;
            color: #333;
            text-align: justify;
            font-family: 'Times New Roman', serif;
        }

        .text-content p {
            margin-bottom: 8px;
        }

        /* ロゴエリア - 左上に移動 */
        .logo-circle-left {
            position: absolute;
            width: 60px;
            height: 60px;
            top: 10px;
            left: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 1;
            transform: scale(1);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .logo-circle-left img {
            width: 60px;
            height: 60px;
            object-fit: contain;
        }

        .logo-circle-left:hover {
            transform: scale(1.1);
        }

        .logo-circle-left.disappearing {
            opacity: 0;
            transform: scale(0) rotate(360deg);
            transition: all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        /* 中央カラム - メイン画像 */
        .center-column {
            background: #fff;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .main-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center center;
            filter: grayscale(100%) contrast(1.2);
            transition: all 0.5s ease;
            display: block;
            background: #f5f5f5;
        }

        /* 数字オーバーレイ */
        .numbers-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }

        .number {
            position: absolute;
            background: rgba(255, 255, 255, 0.9);
            color: #000;
            padding: 4px 8px;
            font-family: Arial, sans-serif;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            pointer-events: auto;
            user-select: none;
            opacity: 0;
            transform: scale(0.5) translateY(20px);
        }

        /* 数字のランダム浮上アニメーション */
        .number.floating {
            opacity: 1;
            transform: scale(1) translateY(0);
            transition: all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .number.disappearing {
            opacity: 0;
            transform: scale(0.5) translateY(-20px);
            transition: all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        @keyframes numberFloat {
            0% { 
                opacity: 0;
                transform: scale(0.5) translateY(20px);
            }
            30% {
                opacity: 0.7;
                transform: scale(1.05) translateY(-3px);
            }
            60% {
                opacity: 1;
                transform: scale(1.02) translateY(-1px);
            }
            100% { 
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes numberFade {
            0% { 
                opacity: 1;
                transform: scale(1) translateY(0);
            }
            40% { 
                opacity: 0.8;
                transform: scale(0.98) translateY(-3px);
            }
            100% { 
                opacity: 0;
                transform: scale(0.5) translateY(-15px);
            }
        }

        .number:hover {
            background: rgba(33, 150, 243, 0.9);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .number.tanka-mode {
            background: rgba(33, 150, 243, 0.95);
            color: white;
            padding: 8px 12px;
            font-size: 10px;
            line-height: 1.3;
            min-width: 120px;
            white-space: pre-line;
            text-align: center;
            border-radius: 4px;
            transform: scale(1.05);
            z-index: 10;
        }

        .number.grabbed {
            animation: grabEffect 0.5s ease-out;
            z-index: 100;
        }

        @keyframes grabEffect {
            0% { transform: scale(1); }
            50% { transform: scale(1.3) rotate(5deg); }
            100% { transform: scale(1) rotate(0deg); }
        }
            border-radius: 3px;
            font-size: 14px;
        }

        /* 数字の個別配置 */
        .n1 { top: 50px; left: 60px; }
        .n2 { top: 80px; right: 80px; }
        .n3 { top: 120px; left: 40px; }
        .n4 { top: 140px; right: 120px; }
        .n5 { top: 180px; left: 80px; }
        .n6 { top: 200px; right: 60px; }
        .n7 { top: 240px; left: 100px; }
        .n8 { top: 260px; right: 100px; }
        .n9 { top: 300px; left: 50px; }
        .n10 { top: 320px; right: 90px; }
        .n11 { top: 360px; left: 120px; }
        .n12 { top: 380px; right: 50px; }
        .n13 { top: 420px; left: 70px; }
        .n14 { top: 440px; right: 110px; }
        .n15 { top: 480px; left: 90px; }
        .n16 { top: 500px; right: 70px; }
        .n17 { bottom: 180px; left: 110px; }
        .n18 { bottom: 160px; right: 80px; }
        .n19 { bottom: 140px; left: 60px; }
        .n20 { bottom: 120px; right: 120px; }
        .n21 { bottom: 100px; left: 140px; }
        .n22 { bottom: 80px; right: 40px; }
        .n23 { bottom: 60px; left: 80px; }
        .n24 { bottom: 40px; right: 100px; }

        /* 青い無限大記号 */
        .infinity-symbol {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 180px;
            color: #2196F3;
            font-weight: bold;
            font-family: Arial, sans-serif;
            z-index: 10;
        }

        /* 右カラム - TIIセクション */
        .right-column {
            background: #666;
            color: #fff;
            padding: 20px;
            position: relative;
            overflow-y: auto;
            height: 100%;
        }

        .news-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .blue-circle-news {
            width: 40px;
            height: 40px;
            background: #2196F3;
            border-radius: 50%;
            margin-right: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 1;
            transform: scale(1);
        }

        .blue-circle-news:hover {
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(33, 150, 243, 0.5);
        }

        .blue-circle-news.disappearing {
            opacity: 0;
            transform: scale(0) rotate(360deg);
            transition: all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .news-title {
            font-size: 32px;
            font-weight: bold;
            color: #fff;
            font-family: Arial, sans-serif;
        }

        .news-content {
            font-size: 11px;
            line-height: 1.4;
            color: #fff;
            text-align: justify;
            font-family: 'Times New Roman', serif;
        }

        .news-content p {
            margin-bottom: 10px;
        }

        /* 青い円 - 右下 */
        .blue-circle-bottom {
            position: absolute;
            width: 80px;
            height: 80px;
            background: #2196F3;
            border-radius: 50%;
            bottom: 100px;
            right: 40px;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 1;
            transform: scale(1);
        }

        .blue-circle-bottom:hover {
            transform: scale(1.1);
            box-shadow: 0 0 25px rgba(33, 150, 243, 0.5);
        }

        .blue-circle-bottom.disappearing {
            opacity: 0;
            transform: scale(0) rotate(360deg);
            transition: all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }


            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
        }

        /* レスポンシブデザイン */
        @media (max-width: 1024px) {
            .main-container {
                grid-template-columns: 1fr;
                grid-template-rows: minmax(280px, 1fr) minmax(350px, auto) minmax(280px, 1fr);
                height: 100vh;
                max-height: none;
                min-height: 100vh;
            }
            
            .infinity-symbol {
                font-size: 120px;
            }
            
            .center-column {
                height: 350px;
            }
            
            .left-column, .right-column {
                height: auto;
                min-height: 280px;
                overflow-y: auto;
                padding: 20px;
                box-sizing: border-box;
            }
        }

        @media (max-width: 768px) {
            .main-container {
                grid-template-rows: minmax(320px, 1fr) minmax(300px, auto) minmax(320px, 1fr);
                height: 100vh;
                min-height: 100vh;
            }
            
            .infinity-symbol {
                font-size: 80px;
            }
            
            .number {
                font-size: 12px;
                padding: 3px 6px;
            }
            
            .center-column {
                height: 300px;
            }
            
            .left-column, .right-column {
                height: auto;
                min-height: 320px;
                padding: 20px 15px;
            }
            
            .extr-text {
                font-size: 32px;
            }
            
            /* モバイル用ロゴ調整 */
            .logo-circle-left {
                width: 50px;
                height: 50px;
                top: 5px;
                left: 5px;
            }
            
            .logo-circle-left img {
                width: 50px;
                height: 50px;
            }
            
            .text-content {
                font-size: 14px;
                line-height: 1.5;
            }
            
            .diary-content {
                font-size: 14px;
                line-height: 1.5;
            }
        }

        /* 高解像度ディスプレイ用 */
        @media (min-height: 900px) {
            .main-container {
                height: 100vh;
                min-height: 100vh;
            }
        }

        /* 小さなスマートフォン用 */
        @media (max-width: 480px) {
            .main-container {
                grid-template-rows: minmax(360px, 1fr) minmax(280px, auto) minmax(360px, 1fr);
                height: 100vh;
                min-height: 100vh;
            }
            
            .left-column, .right-column {
                min-height: 360px;
                padding: 20px 10px;
            }
            
            .center-column {
                height: 280px;
            }
            
            .extr-text {
                font-size: 28px;
                margin-bottom: 15px;
            }
            
            .text-content, .diary-content {
                font-size: 13px;
                line-height: 1.4;
            }
            
            .logo {
                margin-bottom: 20px;
            }
        }

        /* 低解像度ディスプレイ用 */
        @media (max-height: 600px) {
            .main-container {
                height: 100vh;
                min-height: 100vh;
            }
            
            .left-column, .right-column {
                min-height: 200px;
                font-size: 14px;
            }
            
            .extr-text {
                font-size: 36px;
            }
        }

        /* 🎭 縦書き短歌ポップアップスタイル */
        .tanka-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .tanka-popup.show {
            opacity: 1;
            visibility: visible;
        }

        .tanka-popup-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1;
        }

        .tanka-popup-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.98);
            border-radius: 18px;
            padding: 30px 40px;
            min-width: 320px;
            min-height: 360px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 0, 0, 0.1);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2;
        }

        .tanka-close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 20px;
            cursor: pointer;
            color: #666;
            transition: color 0.2s ease;
            font-weight: bold;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tanka-close-btn:hover {
            color: #333;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 50%;
        }

        /* 縦書きテキスト */
        .tanka-vertical-text {
            writing-mode: vertical-rl;
            text-orientation: upright;
            font-family: 'Noto Serif JP', 'Times New Roman', serif;
            font-size: 18px;
            line-height: 1.4;
            color: #222;
            margin: 15px 0;
            padding: 15px;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            letter-spacing: 0.05em;
            font-weight: 500;
            text-shadow: 0 0 1px rgba(0, 0, 0, 0.1);
        }

        .vertical-char {
            display: inline-block;
            text-align: center;
        }

        /* 短歌解説 */
        .tanka-commentary {
            margin: 20px 0;
            font-size: 14px;
            line-height: 1.6;
            color: #555;
            text-align: left;
            font-family: 'Noto Sans JP', Arial, sans-serif;
            background: rgba(240, 240, 240, 0.5);
            padding: 15px 18px;
            border-radius: 10px;
            border-left: 3px solid #2196F3;
            max-width: 260px;
            font-style: italic;
        }

        /* 投票ボタン - 初期状態はグレースケール */
        .tanka-voting {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .vote-btn {
            background: linear-gradient(135deg, #888 0%, #666 100%);
            color: #ccc;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: 80px;
            justify-content: center;
            filter: grayscale(100%);
        }

        .vote-btn:hover {
            transform: translateY(-2px);
            filter: grayscale(0%);
            color: white;
        }

        .like-btn {
            background: linear-gradient(135deg, #888 0%, #666 100%);
        }

        .like-btn:hover {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }

        .dislike-btn {
            background: linear-gradient(135deg, #888 0%, #666 100%);
        }

        .dislike-btn:hover {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            box-shadow: 0 5px 15px rgba(244, 67, 54, 0.4);
        }

        .vote-btn.voted {
            animation: voteAnimation 0.3s ease-out;
        }

        @keyframes voteAnimation {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .vote-count {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 12px;
            min-width: 20px;
        }



        /* 📝 TII Database Styles */
        .tii-write-area {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        #tii-input {
            width: 100%;
            height: 80px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 10px;
            font-size: 12px;
            font-family: 'Times New Roman', serif;
            resize: vertical;
            color: #333;
        }

        #tii-input:focus {
            outline: none;
            border-color: #2196F3;
            background: rgba(255, 255, 255, 0.95);
        }

        .tii-meta {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        #tii-author {
            flex: 1;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            padding: 6px 8px;
            font-size: 11px;
            color: #333;
        }

        #tii-author:focus {
            outline: none;
            border-color: #2196F3;
            background: rgba(255, 255, 255, 0.9);
        }

        #tii-submit {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        #tii-submit:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(33, 150, 243, 0.4);
        }

        #tii-submit:active {
            transform: translateY(0);
        }

        .tii-entries {
            max-height: 300px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
        }

        .tii-entries::-webkit-scrollbar {
            width: 4px;
        }

        .tii-entries::-webkit-scrollbar-track {
            background: transparent;
        }

        .tii-entries::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
        }

        .tii-entry {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
            font-size: 10px;
            line-height: 1.4;
            color: #fff;
        }

        .tii-entry-content {
            margin-bottom: 6px;
            word-wrap: break-word;
        }

        .tii-entry-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 9px;
            color: rgba(255, 255, 255, 0.7);
        }

        .tii-entry-author {
            font-weight: bold;
        }

        .tii-entry-time {
            font-family: 'Courier New', monospace;
        }

        .tii-loading {
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            font-size: 10px;
            padding: 20px;
        }

        .tii-error {
            background: rgba(244, 67, 54, 0.1);
            border: 1px solid rgba(244, 67, 54, 0.3);
            color: #ff6b6b;
            padding: 10px;
            border-radius: 6px;
            font-size: 10px;
            text-align: center;
        }

        /* レスポンシブ対応 */
        @media (max-width: 768px) {
            .tanka-popup-content {
                padding: 25px 30px;
                min-width: 280px;
                margin: 0 20px;
                min-height: 320px;
            }
            
            .tanka-vertical-text {
                font-size: 16px;
                min-height: 100px;
                margin: 12px 0;
                padding: 12px;
            }
            
            .tanka-voting {
                flex-direction: column;
                gap: 8px;
            }

            .vote-btn {
                padding: 6px 12px;
                font-size: 11px;
                min-width: 70px;
            }

            .tanka-commentary {
                font-size: 13px;
                padding: 12px 15px;
                max-width: 220px;
            }

            .tii-write-area {
                padding: 12px;
            }

            #tii-input {
                height: 60px;
                font-size: 11px;
            }

            .tii-entries {
                max-height: 200px;
            }

            /* メニューボタンのモバイル対応 */
            .menu-logos {
                gap: 6px;
                margin-bottom: 20px;
            }

            .menu-btn {
                padding: 6px 10px;
                font-size: 10px;
                border-radius: 15px;
            }

            .maps-img-btn {
                padding: 1px;
            }

            .maps-img {
                height: 28px; /* モバイルでは少し小さく */
            }

            .btn-icon {
                font-size: 12px;
            }

            .btn-text {
                font-size: 9px;
            }

            .extr-text {
                font-size: 42px;
                margin: 25px 0 15px 0;
            }
        }
    </style>
    <!-- 静的写真リスト -->
    <script src="/photos/photo-list.js"></script>
</head>
<body>
    <div class="main-container">
        <!-- 左カラム -->
        <div class="left-column">
            <!-- 左上のロゴを削除（青い丸がロゴ代わりに） -->
            
            <div class="extr-text">SOGOODS.NET</div>
            
            <!-- メニューロゴエリア -->
            <div class="menu-logos">
                <a href="https://www.google.com/maps/contrib/110888846867377060754/photos/@45.8829971,54.1250407,3z/data=!3m1!4b1!4m3!8m2!3m1!1e2?entry=ttu&g_ep=EgoyMDI1MDkyNC4wIKXMDSoASAFQAw%3D%3D" target="_blank" class="maps-img-btn">
                    <img src="/img/button/maps.png" alt="Maps" class="maps-img" />
                </a>
            </div>
            
            <div class="text-content">
                <p>暮らし 質素でも良い。住まいは広すぎず、技術は最新のものを取り入れ、道具は長く使えて愛着があり、社会とは投資を通じて関わり、仕事を通して接する。</p>
                
                <p>人生の半分は、誰かに止められたってしたい事をし、残りの半分は、もっとしたくてしょうがない事をする為にある。</p>
                
                <p>自然の中に美しさを見いだし、思い出の中に楽しさを仕舞い、希望の中に夢を描き、現実の中に光を探す。私たちが、食べたいと思えるものを食べ、あなたと共に、美味しい食卓につき、工夫をこらし、シンプルにゆき着く。</p>
                
                <p>自分たちの考え方や感性を発信し、快適な睡眠をとり、行きたいところに自由に行け、旅を通じて世界を知り、世界を通じて、日本を知る。四季を感じる住まいにすみ、都会の中でもなく、自然の中でもない、絶えず学びの中に身を投じ、情報の洪水から、一杯の清水をすくう。</p>
                
                <p>疎外される事無く、する事無く、差別を受ける事なく、差別をする事なく、後ろ指を指される事なく、指すことをせず、思想、信条、身分を隠す事なく、清廉潔白の中庸で在りたい。</p>
                
                <p>誰かに恋をして、誰かを愛して、誰かから好かれて、愛されて、決して一人ではなく、共感できる家族がいて、子供の考え方に感動し、無限の可能性を感じ、それこそが、生きる理由なのかもしれないと思う。</p>
                
                <p>万が一、明日死んでも未練はあるだろうが、今までの運命を受け入れて、良かったと思える僕でいたい。そうやって、生きてゆける様な私達でありたい。</p>
            </div>
            
            <div class="logo-circle-left">
                <img src="https://sogoods.net/img/logo.png" alt="sogoods.net logo" />
            </div>
        </div>

        <!-- 中央カラム -->
        <div class="center-column">
            <!-- Original cat photo removed as requested -->
            
            <div class="infinity-symbol">∞</div>
            
            <div class="numbers-overlay">
                <div class="number n1">8</div>
                <div class="number n2">2</div>
                <div class="number n3">4</div>
                <div class="number n4">94</div>
                <div class="number n5">81</div>
                <div class="number n6">51</div>
                <div class="number n7">41</div>
                <div class="number n8">4</div>
                <div class="number n9">1078</div>
                <div class="number n10">27</div>
                <div class="number n11">61</div>
                <div class="number n12">54</div>
                <div class="number n13">20</div>
                <div class="number n14">33</div>
                <div class="number n15">91</div>
                <div class="number n16">7</div>
                <div class="number n17">11</div>
                <div class="number n18">19</div>
                <div class="number n19">5</div>
                <div class="number n20">37</div>
                <div class="number n21">15</div>
                <div class="number n22">17</div>
                <div class="number n23">2</div>
                <div class="number n24">47</div>
            </div>
            
            <!-- メイン画像エリア -->
            <img src="" alt="Main Image" class="main-image" id="main-image" />
        </div>

        <!-- 右カラム -->
        <div class="right-column">
            <div class="news-header">
                <div class="blue-circle-news"></div>
                <div class="news-title">TII</div>
            </div>
            
            <div class="news-content" id="tii-content">
                <!-- TII Database Content -->
                <div class="tii-write-area">
                    <textarea id="tii-input" placeholder="今の気持ちや考えを書いてください..." maxlength="500"></textarea>
                    <div class="tii-meta">
                        <input type="text" id="tii-author" placeholder="名前（任意）" maxlength="20">
                        <button id="tii-submit">投稿</button>
                    </div>
                </div>
                
                <div class="tii-entries" id="tii-entries">
                    <!-- エントリーが動的に読み込まれます -->
                </div>
            </div>
            
            <div class="blue-circle-bottom"></div>
        </div>
    </div>

    <!-- 📷 Integrated JavaScript (Combined for Cloudflare Pages) -->
    <script>
    // =============================================================================
    // NOTION API INTEGRATION
    // =============================================================================
    
    /**
     * Notion API連携モジュール
     * 記事・日記・短歌を取得して表示
     */
    
    class NotionAPI {
        constructor(config = {}) {
            this.config = {
                // Notion API設定（後で設定）
                notionToken: config.notionToken || '',
                databaseId: config.databaseId || '',
                corsProxy: config.corsProxy || 'https://cors-anywhere.herokuapp.com/',
                // フォールバック用のサンプルデータ
                useFallback: config.useFallback !== false
            };
        }
    
        /**
         * Notionデータベースから記事を取得
         */
        async fetchArticles(limit = 10) {
            if (!this.config.notionToken || !this.config.databaseId) {
                console.log('Notion APIが設定されていません。サンプルデータを使用します。');
                return this.getFallbackData();
            }
    
            try {
                const response = await fetch(`${this.config.corsProxy}https://api.notion.com/v1/databases/${this.config.databaseId}/query`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${this.config.notionToken}`,
                        'Content-Type': 'application/json',
                        'Notion-Version': '2022-06-28'
                    },
                    body: JSON.stringify({
                        page_size: limit,
                        sorts: [{
                            property: 'Created',
                            direction: 'descending'
                        }]
                    })
                });
    
                if (!response.ok) {
                    throw new Error(`Notion API Error: ${response.status}`);
                }
    
                const data = await response.json();
                return this.processNotionData(data.results);
            } catch (error) {
                console.error('Notion API取得エラー:', error);
                return this.getFallbackData();
            }
        }
    
        /**
         * Notionデータを処理して表示用に変換
         */
        processNotionData(results) {
            return results.map(page => {
                const properties = page.properties;
                
                return {
                    id: page.id,
                    title: this.extractText(properties.Title || properties.Name),
                    content: this.extractText(properties.Content || properties.Excerpt),
                    date: this.extractDate(properties.Date || properties.Created),
                    type: this.extractSelect(properties.Type) || 'article',
                    tags: this.extractMultiSelect(properties.Tags),
                    url: page.url
                };
            });
        }
    
        /**
         * フォールバック用のサンプルデータ
         */
        getFallbackData() {
            const today = new Date();
            return [
                {
                    id: '1',
                    title: '新作写真展のお知らせ',
                    content: '秋の風景をテーマにした写真展を開催します。自然の美しさと季節の移ろいを表現した作品をお楽しみください...',
                    date: this.formatDate(today),
                    type: 'news',
                    tags: ['写真展', '秋']
                },
                {
                    id: '2',
                    title: '風のうた',
                    content: '風涼し\\n山もみじ葉の\\n舞い踊り\\nレンズに映る\\n季節のしらべ',
                    date: this.formatDate(new Date(today.getTime() - 5 * 24 * 60 * 60 * 1000)),
                    type: 'tanka',
                    tags: ['短歌', '自然']
                },
                {
                    id: '3',
                    title: '撮影日記より',
                    content: '今日は早朝から山へ。朝霧が幻想的で、光と影のコントラストが美しい一瞬を捉えることができました...',
                    date: this.formatDate(new Date(today.getTime() - 10 * 24 * 60 * 60 * 1000)),
                    type: 'diary',
                    tags: ['撮影', '山']
                }
            ];
        }
    
        /**
         * Notionのテキストプロパティを抽出
         */
        extractText(property) {
            if (!property) return '';
            
            if (property.title) {
                return property.title.map(text => text.plain_text).join('');
            }
            if (property.rich_text) {
                return property.rich_text.map(text => text.plain_text).join('');
            }
            return '';
        }
    
        /**
         * Notionの日付プロパティを抽出
         */
        extractDate(property) {
            if (!property) return this.formatDate(new Date());
            
            if (property.date && property.date.start) {
                return this.formatDate(new Date(property.date.start));
            }
            if (property.created_time) {
                return this.formatDate(new Date(property.created_time));
            }
            return this.formatDate(new Date());
        }
    
        /**
         * Notionのセレクトプロパティを抽出
         */
        extractSelect(property) {
            return property?.select?.name || '';
        }
    
        /**
         * Notionのマルチセレクトプロパティを抽出
         */
        extractMultiSelect(property) {
            return property?.multi_select?.map(item => item.name) || [];
        }
    
        /**
         * 日付をフォーマット
         */
        formatDate(date) {
            return date.toLocaleDateString('ja-JP', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            }).replace(/\//g, '.');
        }
    
        /**
         * 日記コンテンツを右カラムに表示
         */
        async renderDiary(containerId = 'diary-content') {
            const container = document.getElementById(containerId);
            if (!container) {
                console.log('日記コンテナが見つかりません');
                return;
            }
    
            try {
                console.log('📖 日記コンテンツを読み込み中...');
                const articles = await this.fetchArticles(8);
                
                // 日記・記事・短歌のコンテンツを抽出
                const diaryContent = articles.filter(item => 
                    ['diary', 'article', 'tanka', 'event', 'news'].includes(item.type)
                ).slice(0, 6);
    
                let html = '';
                
                diaryContent.forEach(item => {
                    const formattedContent = this.formatDiaryContent(item.content, item.type);
                    const typeIcon = this.getTypeIcon(item.type);
                    
                    html += `
                        <div class="diary-entry">
                            <div class="diary-meta">
                                <span class="diary-type">${typeIcon}</span>
                                <span class="diary-date">${item.date}</span>
                            </div>
                            <div class="diary-content-text">
                                ${formattedContent}
                            </div>
                        </div>
                    `;
                });
    
                container.innerHTML = html;
                console.log('📖 日記コンテンツの読み込み完了');
    
            } catch (error) {
                console.error('日記読み込みエラー:', error);
                container.innerHTML = `
                    <div class="diary-entry">
                        <p>今日は新しい撮影スポットを探索しました。光と影が織りなす美しい瞬間を捉えることができ、写真の持つ無限の可能性を感じています。</p>
                    </div>
                    <div class="diary-entry">
                        <p>色彩豊かな夕焼けが空を染める時間帯。自然が見せる芸術的な瞬間に心を奪われました。カメラを通して世界を見ることの喜びを再確認しています。</p>
                    </div>
                    <div class="diary-entry">
                        <p>街の小さなカフェで出会った光景。日常に隠れている特別な瞬間を見つけ、それを写真に残すことの大切さを感じました。</p>
                    </div>
                `;
            }
        }
    
        /**
         * 日記用のコンテンツフォーマット
         */
        formatDiaryContent(content, type) {
            if (type === 'tanka') {
                // 短歌の場合は改行を保持し、スタイルを調整
                return `<div class="tanka-content">${content.replace(/\\n/g, '<br>')}</div>`;
            }
            
            // 日記の場合は適度な長さで切り詰め
            const maxLength = 120;
            if (content.length > maxLength) {
                return content.substring(0, maxLength) + '...';
            }
            return content;
        }
    
        /**
         * タイプに応じたアイコンを取得
         */
        getTypeIcon(type) {
            const icons = {
                diary: '📔',
                article: '📝',
                tanka: '🌸',
                event: '📅',
                news: '📰'
            };
            return icons[type] || '📖';
        }
    }
    
    // グローバルインスタンス
    window.notionAPI = new NotionAPI({
        useFallback: true // 現在はサンプルデータを使用
    });
    </script>
    
    <script>
        // 🔗 Initialize systems on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 sogoods.net Dynamic Systems Loading...');
            
            // Photo system is auto-initialized in photo-manager.js
            // Notion integration will be initialized if available
            
            setTimeout(() => {
                console.log('📊 System Status:');
                console.log('   📷 Photo Manager: Active');
                console.log('   🔢 Real-time Stats: Active');
                console.log('   🔄 Auto-refresh: 30s photos, 5s stats');
                console.log('   🎭 Interactive Features: Active');
                console.log('');
                console.log('📁 Add photos to:');
                console.log('   • /photos/miiko/ (main display)');
                console.log('   • /photos/gallery/ (mini images)');
            }, 1000);

            // 🎭 Interactive Features Initialization
            initializeInteractiveFeatures();
            
            // 📝 TII Database System Initialization
            initializeTIISystem();
        });

        // 🔵 Blue Circle Interaction System
        function initializeInteractiveFeatures() {
            console.log('🎭 Initializing interactive features...');
            
            // Blue circle disappearing effect (ロゴ円も含む)
            const blueCircles = document.querySelectorAll('.logo-circle-left, .blue-circle-news, .blue-circle-bottom');
            blueCircles.forEach(circle => {
                circle.addEventListener('click', function() {
                    console.log('🔵 Blue circle clicked - disappearing...');
                    this.classList.add('disappearing');
                    
                    // Remove element after animation
                    setTimeout(() => {
                        this.style.display = 'none';
                    }, 600);
                });
            });

            // 🔢 Number to Tanka transformation
            initializeTankaSystem();
            
            // 🖼️ Mini Gallery popup functionality  
            initializeMiniGallery();
        }

        // 🖼️ Mini Gallery Popup System
        function initializeMiniGallery() {
            console.log('🖼️ Initializing mini gallery popup...');
            
            const miniImages = document.querySelectorAll('.mini-image');
            miniImages.forEach(img => {
                img.addEventListener('click', function() {
                    const originalSrc = this.getAttribute('data-original');
                    const photoType = this.getAttribute('data-photo-type');
                    const fileName = this.getAttribute('data-file-name');
                    
                    console.log(`🖼️ Mini gallery clicked: ${photoType} - ${fileName}`);
                    showMiniGalleryPopup(this.src, this.alt, originalSrc);
                });
                
                // ホバー効果を追加
                img.style.cursor = 'pointer';
                img.style.transition = 'transform 0.2s ease';
                
                img.addEventListener('mouseenter', function() {
                    this.style.transform = 'scale(1.05)';
                });
                
                img.addEventListener('mouseleave', function() {
                    this.style.transform = 'scale(1)';
                });
            });
        }

        function showMiniGalleryPopup(thumbnailSrc, imageAlt, originalSrc = null) {
            console.log('🖼️ Opening mini gallery popup - Original:', originalSrc || thumbnailSrc);
            
            // 既存のポップアップを削除
            const existingPopup = document.querySelector('.mini-gallery-popup');
            if (existingPopup) {
                existingPopup.remove();
            }

            // オリジナル画像があればそれを使用、なければサムネイルを高解像度化
            const displaySrc = originalSrc || thumbnailSrc.replace('w=100&h=75', 'w=1200&h=900');

            const popup = document.createElement('div');
            popup.className = 'mini-gallery-popup';
            popup.innerHTML = `
                <img src="${displaySrc}" alt="${imageAlt}">
            `;

            popup.addEventListener('click', function() {
                popup.classList.remove('show');
                setTimeout(() => popup.remove(), 300);
            });

            document.body.appendChild(popup);

            // アニメーション
            requestAnimationFrame(() => {
                popup.classList.add('show');
            });

            console.log(`🖼️ Showing gallery popup: ${imageAlt}`);
        }

        // 📝 Short Poem (Tanka) Collection System
        const tankaCollection = [
            "冬の朝\n窓辺に座る\n猫の瞳\n静寂を映し\n時が止まる",
            "桜散り\n風に舞い踊る\n花びらよ\n心に残る\n春の記憶",
            "夕暮れに\n街灯が点く\n道すがら\n影が長くて\n家路急ぐ",
            "雨音が\n屋根を叩いて\n響くとき\n本を開いて\n静かに読む",
            "星空を\n見上げる夜に\n思うこと\n小さな自分\n大きな宇宙",
            "コーヒーの\n湯気が立ち上る\n朝のひと時\nゆっくりと\n今日を始める",
            "写真の中\n笑顔が語る\n物語\n時を超えて\n心に響く",
            "海の波\n砂浜に寄せる\nリズムに\n心も軽やか\n歩いてゆく",
            "緑陰で\n風が頬を\n撫でていく\n木漏れ日踊り\n夏を感じる",
            "月明かり\n窓から差して\n部屋を照らす\n静かな夜に\n思いを馳せる",
            "朝露に\n光が宿り\nキラキラと\n新しい日の\n始まりを告げる",
            "友と過ごす\n何気ない時間\nかけがえのない\n笑い声が\n記憶に刻まれる",
            "本の頁\nめくるたびに\n新世界\n想像の翼\n広がってゆく",
            "小鳥たち\n空を自由に\n飛び回り\n羨ましくて\n見上げる空",
            "花壇には\n色とりどりの\n花が咲き\n蝶が舞い踊る\n午後のひととき",
            "夕陽が\n空を染めて\nオレンジ色\n今日という日を\n美しく終える",
            "雲が流れ\n形を変えて\n空の旅\n想像膨らむ\n青い午後",
            "キッチンで\n料理する音\n心地よく\n家族の笑顔\n思い浮かべて",
            "散歩道\n季節の移ろい\n感じつつ\n一歩一歩が\n人生の歩み",
            "夜更けに\n静寂包まれ\n考える\n明日への希望\n胸に秘めて",
            "古い写真\n思い出蘇り\n懐かしく\nあの日の自分に\n会いに行ける",
            "雪景色\n真っ白な世界\n包まれて\n心も清らか\n新しい気持ち",
            "温かい\n家族の団らん\n囲んで\n幸せだなと\n心から思う",
            "新緑が\n風に揺れて\n輝いて\n命あふれる\n季節の始まり"
        ];

        let tankaIndex = 0;
        const collectedTanka = [];

        function initializeTankaSystem() {
            console.log('📝 Initializing Tanka transformation system...');
            
            const numbers = document.querySelectorAll('.number');
            
            numbers.forEach((number, index) => {
                let isTransformed = false;
                let hoverTimeout;
                
                // Mouse enter - show tanka after delay
                number.addEventListener('mouseenter', function() {
                    if (isTransformed) return;
                    
                    hoverTimeout = setTimeout(() => {
                        showTanka(this, index);
                        isTransformed = true;
                    }, 800); // 0.8秒後に短歌表示
                });
                
                // Mouse leave - clear timeout if not transformed yet
                number.addEventListener('mouseleave', function() {
                    clearTimeout(hoverTimeout);
                    
                    if (isTransformed) {
                        // Reset to number after some time
                        setTimeout(() => {
                            resetToNumber(this, index);
                            isTransformed = false;
                        }, 2000);
                    }
                });
                
                // Click - grab the tanka
                number.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (isTransformed) {
                        grabTanka(this, index);
                    } else {
                        // Quick transform on click
                        clearTimeout(hoverTimeout);
                        showTanka(this, index);
                        isTransformed = true;
                        
                        setTimeout(() => {
                            grabTanka(this, index);
                        }, 500);
                    }
                });
            });
        }

        function showTanka(element, index) {
            // Use CSV-based tanka system if available
            if (window.tankaSystem && window.tankaSystem.isInitialized) {
                const tanka = window.tankaSystem.getRandomTanka();
                if (tanka) {
                    element.classList.add('tanka-mode');
                    element.textContent = tanka.text;
                    element.setAttribute('data-tanka-id', tanka.id);
                    element.setAttribute('data-tanka', tanka.text);
                    
                    console.log(`📝 Showing CSV tanka ${tanka.id}: "${tanka.text.substring(0, 30)}..."`);
                    return;
                }
            }
            
            // Fallback to static collection
            const tanka = tankaCollection[tankaIndex % tankaCollection.length];
            tankaIndex++;
            
            element.classList.add('tanka-mode');
            element.textContent = tanka;
            element.setAttribute('data-tanka', tanka);
            
            console.log(`📝 Showing static tanka ${tankaIndex}: "${tanka.replace(/\n/g, ' / ')}"`);
        }

        function resetToNumber(element, index) {
            element.classList.remove('tanka-mode');
            element.textContent = element.getAttribute('data-original-number') || (index + 1);
        }

        function grabTanka(element, index) {
            const tankaId = element.getAttribute('data-tanka-id');
            const tanka = element.getAttribute('data-tanka');
            if (!tanka) return;
            
            element.classList.add('grabbed');
            
            // Use advanced tanka system for CSV-based tanka
            if (tankaId && window.tankaSystem && window.tankaSystem.isInitialized) {
                const tankaData = window.tankaSystem.tankaDatabase.find(t => t.id == tankaId);
                if (tankaData) {
                    window.tankaSystem.displayVerticalTanka(tankaData, element);
                    console.log(`🤏 Opening vertical tanka display for CSV tanka ${tankaId}`);
                    return;
                }
            }
            
            // Fallback for static tanka
            collectedTanka.push(tanka);
            
            console.log(`🤏 Grabbed static tanka: "${tanka.replace(/\n/g, ' / ')}"`);
            console.log(`📚 Collection now has ${collectedTanka.length} tanka(s)`);
            
            // Visual feedback for static tanka
            const grabMessage = document.createElement('div');
            grabMessage.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(33, 150, 243, 0.9);
                color: white;
                padding: 10px 20px;
                border-radius: 20px;
                font-size: 14px;
                z-index: 1000;
                animation: fadeInOut 2s ease-out forwards;
                pointer-events: none;
            `;
            
            grabMessage.textContent = `📚 短歌をつかみました！ (${collectedTanka.length}首目)`;
            document.body.appendChild(grabMessage);
            
            // Add fadeInOut animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeInOut {
                    0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
                    20% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                    80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                    100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
                }
            `;
            document.head.appendChild(style);
            
            setTimeout(() => {
                grabMessage.remove();
                style.remove();
            }, 2000);
            
            // Reset element
            setTimeout(() => {
                resetToNumber(element, index);
                element.classList.remove('grabbed');
            }, 1000);
        }

        // 📝 TII Database System
        function initializeTIISystem() {
            console.log('📝 Initializing TII database system...');
            
            const submitButton = document.getElementById('tii-submit');
            const inputTextarea = document.getElementById('tii-input');
            const authorInput = document.getElementById('tii-author');

            if (submitButton && inputTextarea) {
                submitButton.addEventListener('click', submitTIIEntry);
                
                // Enter key submit (Ctrl+Enter)
                inputTextarea.addEventListener('keydown', function(e) {
                    if (e.ctrlKey && e.key === 'Enter') {
                        submitTIIEntry();
                    }
                });
            }

            // Load existing entries
            loadTIIEntries();

            // Auto-refresh entries every 30 seconds
            setInterval(loadTIIEntries, 30000);
        }

        async function submitTIIEntry() {
            const input = document.getElementById('tii-input');
            const author = document.getElementById('tii-author');
            const submitBtn = document.getElementById('tii-submit');

            const content = input.value.trim();
            if (!content) {
                alert('内容を入力してください');
                return;
            }

            // Disable button during submission
            submitBtn.disabled = true;
            submitBtn.textContent = '投稿中...';

            try {
                // localStorage基盤での投稿処理
                const authorName = author.value.trim() || '匿名';
                const timestamp = new Date().toISOString();
                
                // 既存のエントリーを取得
                const existingEntries = JSON.parse(localStorage.getItem('tii-entries') || '[]');
                
                // 新しいエントリーを作成
                const newEntry = {
                    id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    content: content,
                    author: authorName,
                    timestamp: timestamp
                };
                
                // 新しいエントリーを配列の先頭に追加（最新順）
                existingEntries.unshift(newEntry);
                
                // 最大100エントリーに制限
                if (existingEntries.length > 100) {
                    existingEntries.splice(100);
                }
                
                // localStorageに保存
                localStorage.setItem('tii-entries', JSON.stringify(existingEntries));
                
                console.log('✅ TII entry submitted successfully to localStorage');
                
                // Clear form
                input.value = '';
                author.value = '';
                
                // Reload entries
                loadTIIEntries();
                
                // Visual feedback
                showTIIFeedback('投稿が完了しました！', 'success');

            } catch (error) {
                console.error('❌ TII submission failed:', error);
                showTIIFeedback('投稿に失敗しました', 'error');
            } finally {
                // Re-enable button
                submitBtn.disabled = false;
                submitBtn.textContent = '投稿';
            }
        }

        async function loadTIIEntries() {
            const entriesContainer = document.getElementById('tii-entries');
            if (!entriesContainer) return;

            try {
                // localStorageからエントリーを読み込み
                const entries = JSON.parse(localStorage.getItem('tii-entries') || '[]');
                
                // エントリーを新しい順にソート
                entries.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                displayTIIEntries(entries);
                console.log(`📝 Loaded ${entries.length} TII entries from localStorage`);

            } catch (error) {
                console.error('❌ Failed to load TII entries:', error);
                entriesContainer.innerHTML = '<div class="tii-error">エントリーの読み込みに失敗しました</div>';
            }
        }

        function displayTIIEntries(entries) {
            const container = document.getElementById('tii-entries');
            if (!container) return;

            if (entries.length === 0) {
                container.innerHTML = '<div class="tii-loading">まだエントリーがありません</div>';
                return;
            }

            const entriesHTML = entries.map(entry => {
                const date = new Date(entry.timestamp);
                const timeString = date.toLocaleDateString('ja-JP', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                return `
                    <div class="tii-entry">
                        <div class="tii-entry-content">${escapeHtml(entry.content)}</div>
                        <div class="tii-entry-meta">
                            <span class="tii-entry-author">${escapeHtml(entry.author)}</span>
                            <span class="tii-entry-time">${timeString}</span>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = entriesHTML;
        }

        function showTIIFeedback(message, type) {
            const feedback = document.createElement('div');
            feedback.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? 'rgba(76, 175, 80, 0.9)' : 'rgba(244, 67, 54, 0.9)'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 14px;
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
            `;
            
            feedback.textContent = message;
            document.body.appendChild(feedback);

            setTimeout(() => {
                feedback.style.animation = 'slideOut 0.3s ease-out forwards';
                setTimeout(() => feedback.remove(), 300);
            }, 2000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Store original numbers for reset
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                const numbers = document.querySelectorAll('.number');
                numbers.forEach((number, index) => {
                    number.setAttribute('data-original-number', number.textContent);
                });
            }, 100);
        });

        // 📸 PhotoManager Integration - sogoods.net Photo Manager
        /**
         * sogoods.net Photo Manager
         * ランダム写真表示とリアルタイムデータ管理システム
         */

        class PhotoManager {
            constructor() {
                this.photosPath = '/photos';
                this.miikoPhotos = [];
                this.galleryPhotos = [];
                this.uploadedPhotos = []; // アップロードされた写真を保存
                this.currentPhoto = null;
                this.updateInterval = null;
                this.serverStorageEnabled = false; // サーバーサイドストレージフラグ
                this.stats = {
                    totalPhotos: 0,
                    viewCount: 0,
                    lastUpdate: new Date(),
                    randomSeed: Math.floor(Math.random() * 1000)
                };
                
                this.init();
            }

            async init() {
                // サーバーサイドストレージ可用性チェック
                await this.checkServerStorage();
                
                // アップロード写真を復元
                this.loadUploadedPhotos();
                
                await this.loadPhotoList();
                this.setupRandomDisplay();
                this.setupRealtimeStats();
                this.loadStats();
                
                // デバッグモードでFlickr接続テスト
                if (window.location.hostname.includes('localhost') || window.location.hostname.includes('e2b.dev')) {
                    setTimeout(() => this.testFlickrConnection(), 3000);
                }
            }

            // サーバーサイドストレージの可用性をチェック
            async checkServerStorage() {
                try {
                    console.log('🔍 Checking server-side storage availability...');
                    
                    const response = await fetch('/api/photos/miiko', {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            this.serverStorageEnabled = true;
                            console.log(`✅ Server storage available - ${result.totalCount} photos in /photos/miiko/`);
                            
                            // サーバーから既存の写真リストを取得してmiikoPhotosに統合
                            if (result.photos && result.photos.length > 0) {
                                const serverPhotos = result.photos.map(photo => photo.url);
                                console.log('📁 Server photos:', serverPhotos.length);
                            }
                        } else {
                            console.log('⚠️ Server storage API unavailable');
                        }
                    } else {
                        console.log('⚠️ Server storage not responding');
                    }
                } catch (error) {
                    console.log('⚠️ Server storage check failed:', error.message);
                }

                console.log(`📦 Storage mode: ${this.serverStorageEnabled ? 'Server-side (/photos/miiko/)' : 'Browser-only (localStorage)'}`);
            }

            // 写真リストを動的に読み込み（静的フォルダ + API）
            async loadPhotoList() {
                try {
                    console.log('📸 Loading photos from multiple sources...');
                    
                    // 静的写真フォルダから写真を取得
                    const staticPhotos = await this.loadStaticPhotos();
                    
                    // サーバーストレージから写真を取得（フォールバック）
                    const serverPhotos = await this.loadServerPhotos();
                    
                    // Flickrから写真を取得（フォールバック）
                    const flickrPhotos = await this.fetchFlickrPhotos();
                    
                    // 静的フォルダの写真が最優先
                    if (staticPhotos.mainPhotos.length > 0 || staticPhotos.galleryPhotos.length > 0) {
                        this.miikoPhotos = staticPhotos.mainPhotos;
                        this.galleryPhotos = staticPhotos.galleryPhotos;
                        
                        this.stats.totalPhotos = staticPhotos.mainPhotos.length + staticPhotos.galleryPhotos.length + this.uploadedPhotos.length;
                        console.log(`📷 Static photos loaded: ${staticPhotos.mainPhotos.length} main, ${staticPhotos.galleryPhotos.length} gallery, ${this.uploadedPhotos.length} uploaded`);
                        console.log(`📦 Storage mode: Static folders (/photos/main/, /photos/gallery/)`);
                        return;
                    }
                    
                    // フォールバック：サーバーAPI + Flickr
                    let allPhotos = [...serverPhotos];
                    
                    if (flickrPhotos && flickrPhotos.length > 0) {
                        allPhotos = [...allPhotos, ...flickrPhotos];
                        console.log(`📷 Combined: ${serverPhotos.length} server + ${flickrPhotos.length} Flickr photos`);
                    } else if (serverPhotos.length === 0) {
                        console.log('⚠️ No server or Flickr photos, using sample photos');
                        allPhotos = this.getSamplePhotos();
                    }
                    
                    if (allPhotos.length > 0) {
                        // メイン画像用とギャラリー用に分割
                        this.miikoPhotos = allPhotos.slice(0, Math.ceil(allPhotos.length * 0.7));
                        this.galleryPhotos = allPhotos.slice(Math.ceil(allPhotos.length * 0.7));
                        
                        this.stats.totalPhotos = allPhotos.length + this.uploadedPhotos.length;
                        console.log(`📷 Final: ${this.miikoPhotos.length} main photos, ${this.galleryPhotos.length} gallery photos, ${this.uploadedPhotos.length} uploaded photos`);
                        console.log(`📦 Storage: ${this.serverStorageEnabled ? 'Server + Browser' : 'Browser only'}`);
                    } else {
                        // 完全フォールバック
                        this.miikoPhotos = this.getSamplePhotos();
                        this.galleryPhotos = [];
                        this.stats.totalPhotos = this.miikoPhotos.length + this.uploadedPhotos.length;
                    }
                    
                } catch (error) {
                    console.warn('📁 Photo loading failed, using sample photos:', error.message);
                    this.miikoPhotos = this.getSamplePhotos();
                    this.galleryPhotos = [];
                    this.stats.totalPhotos = this.miikoPhotos.length + this.uploadedPhotos.length;
                }
            }

            // 静的写真フォルダから写真を取得
            async loadStaticPhotos() {
                try {
                    console.log('📁 Loading static photos from /photos/ folders...');
                    
                    // 静的写真リストを読み込み
                    const response = await fetch('/photos/photo-list.js');
                    
                    if (response.ok) {
                        const scriptText = await response.text();
                        
                        // photo-list.jsをevalで実行（セキュア環境なのでOK）
                        eval(scriptText);
                        
                        if (window.sogoodsPhotoList) {
                            const mainPhotos = window.sogoodsPhotoList.main.map(filename => 
                                `/photos/main/${filename}`
                            );
                            const galleryPhotos = window.sogoodsPhotoList.gallery.map(filename => 
                                `/photos/gallery/${filename}`
                            );
                            
                            console.log(`✅ Static photos loaded: ${mainPhotos.length} main, ${galleryPhotos.length} gallery`);
                            console.log(`📅 Last updated: ${window.sogoodsPhotoList.lastUpdated}`);
                            
                            return {
                                mainPhotos,
                                galleryPhotos
                            };
                        }
                    }
                    
                    throw new Error('Photo list not available');
                    
                } catch (error) {
                    console.warn('⚠️ Static photo loading failed:', error.message);
                    return {
                        mainPhotos: [],
                        galleryPhotos: []
                    };
                }
            }

            // サーバーから写真リストを取得（フォールバック用）
            async loadServerPhotos() {
                if (!this.serverStorageEnabled) return [];

                try {
                    const response = await fetch('/api/photos/miiko');
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.photos) {
                            console.log(`📁 Loaded ${result.photos.length} photos from server storage`);
                            return result.photos.map(photo => photo.url);
                        }
                    }
                } catch (error) {
                    console.error('❌ Failed to load server photos:', error);
                }
                
                return [];
            }

            // Flickr APIから写真を取得（CORS対応版）
            async fetchFlickrPhotos() {
                try {
                    console.log('📸 Attempting to fetch photos from Flickr...');
                    
                    // 代替手段1: Flickrの直接画像URLを使用（手動キュレーション）
                    const curatedFlickrPhotos = await this.getCuratedFlickrPhotos();
                    if (curatedFlickrPhotos.length > 0) {
                        console.log(`✅ Flickr: Using curated photos (${curatedFlickrPhotos.length} photos)`);
                        return curatedFlickrPhotos;
                    }
                    
                    throw new Error('All Flickr methods failed');
                    
                } catch (error) {
                    console.warn('❌ Flickr API Error:', error.message);
                    return null;
                }
            }

            // sogoods Flickrアカウントからの厳選写真（サーバー経由）
            async getCuratedFlickrPhotos() {
                try {
                    console.log('📸 Fetching sogoods Flickr photos via server API...');
                    
                    const response = await fetch('/api/flickr-photos');
                    
                    if (!response.ok) {
                        throw new Error(`Server error: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.success && data.photos && data.photos.length > 0) {
                        const photoUrls = data.photos.map(photo => photo.url);
                        console.log(`✅ Server Flickr API: Retrieved ${photoUrls.length} photos from ${data.sourcePhotoIds} IDs`);
                        console.log('📷 Flickr photos:', photoUrls.slice(0, 3).map(url => url.split('/').pop()));
                        return photoUrls;
                    } else {
                        console.warn('❌ No valid photos from server Flickr API');
                        return [];
                    }
                    
                } catch (error) {
                    console.warn('❌ Server Flickr API failed:', error.message);
                    return [];
                }
            }

            // Flickrの接続テスト用関数（デバッグ用）
            async testFlickrConnection() {
                console.log('🔍 Testing Flickr API connection...');
                try {
                    const photos = await this.fetchFlickrPhotos();
                    if (photos && photos.length > 0) {
                        console.log(`✅ Flickr Test: Successfully retrieved ${photos.length} photos`);
                        console.log('📷 First photo URL:', photos[0]);
                        return true;
                    } else {
                        console.log('❌ Flickr Test: No photos retrieved');
                        return false;
                    }
                } catch (error) {
                    console.log('❌ Flickr Test Error:', error);
                    return false;
                }
            }

            // フォールバック用空配列（Flickr写真のみを使用）
            getSamplePhotos() {
                console.log('⚠️ No Flickr photos available - returning empty array');
                return [];
            }

            // ランダム写真表示の設定
            setupRandomDisplay() {
                // 初期表示
                this.displayRandomPhoto();
                
                // 30秒ごとに写真を変更
                setInterval(() => {
                    this.displayRandomPhoto();
                }, 30000);

                // 小さいギャラリーも更新
                this.updateMiniGallery();
                
                // 5分ごとにギャラリー更新
                setInterval(() => {
                    this.updateMiniGallery();
                }, 300000);
            }

            // ランダムに写真を表示（自動リサイズ付き）
            displayRandomPhoto() {
                // アップロード写真のオリジナル + Flickr写真を組み合わせ
                const uploadedOriginals = this.uploadedPhotos.map(photo => 
                    typeof photo === 'object' ? photo.original : photo
                );
                const allMainPhotos = [...uploadedOriginals, ...this.miikoPhotos];
                
                if (allMainPhotos.length === 0) return;
                
                const randomIndex = Math.floor(Math.random() * allMainPhotos.length);
                const selectedPhoto = allMainPhotos[randomIndex];
                
                const mainImage = document.querySelector('.main-image');
                if (mainImage) {
                    this.loadImageWithAutoResize(selectedPhoto, mainImage, {
                        targetWidth: 800,
                        targetHeight: 1200,
                        quality: 0.8
                    });
                    this.currentPhoto = selectedPhoto;
                    this.stats.viewCount++;
                }
                
                const photoType = randomIndex < uploadedOriginals.length ? 'uploaded' : 'flickr';
                console.log(`🎲 Random photo: ${randomIndex + 1}/${allMainPhotos.length} (${photoType})`);
            }

            // 小さなギャラリーを更新（サムネイル使用、オリジナルポップアップ対応）
            updateMiniGallery() {
                const miniImages = document.querySelectorAll('.mini-image');
                
                // アップロード写真（サムネイル/オリジナル） + Flickr写真を組み合わせ
                const allPhotos = [];
                
                // アップロード写真の処理（サムネイル表示、オリジナルポップアップ）
                this.uploadedPhotos.forEach(photo => {
                    if (typeof photo === 'object') {
                        allPhotos.push({
                            thumbnail: photo.thumbnail || photo.original,
                            original: photo.original,
                            type: 'uploaded',
                            fileName: photo.fileName
                        });
                    } else {
                        // 古い形式のサポート
                        allPhotos.push({
                            thumbnail: photo,
                            original: photo,
                            type: 'uploaded',
                            fileName: 'legacy'
                        });
                    }
                });
                
                // Flickr写真の処理
                [...this.miikoPhotos, ...this.galleryPhotos].forEach(photo => {
                    allPhotos.push({
                        thumbnail: photo,
                        original: photo,
                        type: 'flickr',
                        fileName: 'flickr'
                    });
                });
                
                if (allPhotos.length === 0) return;
                
                miniImages.forEach((img, index) => {
                    const randomIndex = Math.floor(Math.random() * allPhotos.length);
                    const photoData = allPhotos[randomIndex];
                    
                    // サムネイル画像をミニギャラリーに表示（グレースケール）
                    this.loadImageWithAutoResize(photoData.thumbnail, img, {
                        targetWidth: 120,
                        targetHeight: 90,
                        quality: 0.7,
                        applyColorProcessing: 'grayscale'  // ほぼグレースケール
                    });
                    
                    // オリジナル画像をdata属性として保存
                    img.setAttribute('data-original', photoData.original);
                    img.setAttribute('data-photo-type', photoData.type);
                    img.setAttribute('data-file-name', photoData.fileName);
                    
                    // ホバーエフェクト用のオリジナル色画像を準備
                    this.setupMiniGalleryHoverEffect(img, photoData.thumbnail);
                });
                
                console.log(`🖼️ Mini gallery updated: ${allPhotos.length} photos available (${this.uploadedPhotos.length} uploaded)`);
            }

            // アップロードされた写真をランダム表示に追加（サムネイルとオリジナル両方保存）
            addUploadedPhoto(dataUrl, fileName) {
                // 写真オブジェクトを作成（オリジナルとサムネイルの両方を保存）
                const photoObject = {
                    id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    fileName: fileName,
                    original: dataUrl,  // オリジナル画像
                    thumbnail: null,    // サムネイルは後で生成
                    uploadDate: new Date().toISOString()
                };
                
                // サムネイル生成
                this.generateThumbnail(dataUrl, 120, 90, 0.7).then(thumbnailDataUrl => {
                    photoObject.thumbnail = thumbnailDataUrl;
                });
                
                // アップロード写真配列に追加
                this.uploadedPhotos.push(photoObject);
                
                // 統計更新
                this.stats.totalPhotos = this.uploadedPhotos.length + this.miikoPhotos.length + this.galleryPhotos.length;
                this.stats.lastUpdate = new Date();
                
                // ローカルストレージに保存（セッション維持）
                this.saveUploadedPhotos();
                
                console.log(`📤 Photo added to rotation: ${fileName}`);
                console.log(`📊 Total photos in rotation: ${this.stats.totalPhotos} (${this.uploadedPhotos.length} uploaded)`);
                
                // ミニギャラリーとメイン画像を更新
                this.updateMiniGallery();
                this.displayRandomPhoto(); // メイン画像もすぐに新しい写真を表示可能に
            }

            // アップロード写真をローカルストレージに保存
            saveUploadedPhotos() {
                try {
                    // データURL は大きいので、最新の10枚のみ保存
                    const recentPhotos = this.uploadedPhotos.slice(-10);
                    localStorage.setItem('sogoods_uploaded_photos', JSON.stringify(recentPhotos));
                } catch (error) {
                    console.warn('⚠️ Failed to save uploaded photos to localStorage:', error);
                }
            }

            // ローカルストレージからアップロード写真を復元
            loadUploadedPhotos() {
                try {
                    const savedPhotos = localStorage.getItem('sogoods_uploaded_photos');
                    if (savedPhotos) {
                        this.uploadedPhotos = JSON.parse(savedPhotos);
                        console.log(`📁 Restored ${this.uploadedPhotos.length} uploaded photos from storage`);
                    }
                } catch (error) {
                    console.warn('⚠️ Failed to load uploaded photos from localStorage:', error);
                    this.uploadedPhotos = [];
                }
            }

            // リアルタイム統計の設定
            setupRealtimeStats() {
                this.updateStats();
                
                // 5秒ごとに統計を更新
                this.updateInterval = setInterval(() => {
                    this.updateStats();
                }, 5000);
            }

            // 意味のある数字を生成・更新
            updateStats() {
                const now = new Date();
                this.stats.lastUpdate = now;
                
                // 現在時刻ベースの動的数字
                const currentStats = {
                    hour: now.getHours(),
                    minute: now.getMinutes(),
                    day: now.getDate(),
                    month: now.getMonth() + 1,
                    totalPhotos: this.stats.totalPhotos,
                    viewCount: this.stats.viewCount,
                    uptime: Math.floor((now - this.stats.startTime) / 1000 / 60), // 分単位
                    randomValue: Math.floor(Math.random() * 100) + 1,
                    heartbeat: Math.floor(Math.random() * 40) + 60, // 60-100 BPM
                    temperature: Math.floor(Math.random() * 10) + 18, // 18-28°C
                    humidity: Math.floor(Math.random() * 30) + 40, // 40-70%
                    visitors: Math.floor(Math.random() * 50) + this.stats.viewCount
                };
                
                this.updateNumberOverlays(currentStats);
                
                // localStorage に保存
                this.saveStats();
            }

            // 数字オーバーレイを更新
            updateNumberOverlays(stats) {
                const numbers = document.querySelectorAll('.number');
                if (numbers.length === 0) return;
                
                // 意味のある数字のマッピング
                const meaningfulNumbers = [
                    stats.hour,                    // 現在時刻
                    stats.minute,                  // 現在分
                    stats.day,                     // 今日の日付
                    stats.month,                   // 現在月
                    stats.totalPhotos,             // 総写真数
                    stats.viewCount,               // 閲覧数
                    stats.uptime,                  // 稼働時間（分）
                    stats.randomValue,             // ランダム値
                    stats.heartbeat,               // 心拍数風
                    stats.temperature,             // 温度風
                    stats.humidity,                // 湿度風
                    stats.visitors,                // 訪問者数風
                    Math.floor(Math.random() * 365) + 1,  // 年内日数
                    Math.floor(Math.random() * 24) + 1,   // 時間
                    Math.floor(Math.random() * 60) + 1,   // 分・秒
                    Math.floor(Math.random() * 12) + 1,   // 月
                    Math.floor(Math.random() * 999) + 1,  // ランダム3桁
                    Math.floor(Math.random() * 99) + 1,   // ランダム2桁
                    Math.floor(Math.random() * 9) + 1,    // ランダム1桁
                    Math.floor(Math.random() * 50) + 1,   // 小さなランダム値
                    Math.floor(Math.random() * 200) + 100, // 大きめのランダム値
                    Math.floor(Math.random() * 10) + 1,   // シンプルな数字
                    Math.floor(Math.random() * 77) + 1,   // 特別な範囲
                    stats.viewCount % 100              // 閲覧数の下2桁
                ];
                
                numbers.forEach((numberEl, index) => {
                    if (index < meaningfulNumbers.length) {
                        numberEl.textContent = meaningfulNumbers[index];
                    }
                });
                
                console.log(`🔢 Stats updated: ${stats.hour}:${stats.minute}, Photos: ${stats.totalPhotos}, Views: ${stats.viewCount}`);
            }

            // 統計をlocalStorageから読み込み
            loadStats() {
                const saved = localStorage.getItem('sogoods_stats');
                if (saved) {
                    const savedStats = JSON.parse(saved);
                    this.stats = { ...this.stats, ...savedStats };
                }
                
                // 開始時刻を設定（初回のみ）
                if (!this.stats.startTime) {
                    this.stats.startTime = new Date();
                } else {
                    this.stats.startTime = new Date(this.stats.startTime);
                }
            }

            // 統計をlocalStorageに保存
            saveStats() {
                localStorage.setItem('sogoods_stats', JSON.stringify(this.stats));
            }

            // 自動リサイズ付き画像読み込み
            loadImageWithAutoResize(src, imgElement, options = {}) {
                const {
                    targetWidth = 800,
                    targetHeight = 600,
                    quality = 0.8,
                    fitMode = 'cover', // cover, contain, fill
                    applyColorProcessing = false // 色処理オプション ('grayscale', true, false)
                } = options;

                // 一時的にローディング表示
                imgElement.style.opacity = '0.5';
                
                const img = new Image();
                img.crossOrigin = 'anonymous'; // CORS対応
                
                img.onload = () => {
                    try {
                        // Canvas で自動リサイズ・クロップ
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // アスペクト比計算
                        const sourceRatio = img.width / img.height;
                        const targetRatio = targetWidth / targetHeight;
                        
                        let drawWidth, drawHeight, offsetX = 0, offsetY = 0;
                        
                        if (fitMode === 'cover') {
                            // cover: はみ出した部分をクロップ
                            if (sourceRatio > targetRatio) {
                                drawHeight = targetHeight;
                                drawWidth = drawHeight * sourceRatio;
                                offsetX = (targetWidth - drawWidth) / 2;
                            } else {
                                drawWidth = targetWidth;
                                drawHeight = drawWidth / sourceRatio;
                                offsetY = (targetHeight - drawHeight) / 2;
                            }
                            canvas.width = targetWidth;
                            canvas.height = targetHeight;
                        } else if (fitMode === 'contain') {
                            // contain: 全体を表示、余白あり
                            if (sourceRatio > targetRatio) {
                                drawWidth = targetWidth;
                                drawHeight = drawWidth / sourceRatio;
                                offsetY = (targetHeight - drawHeight) / 2;
                            } else {
                                drawHeight = targetHeight;
                                drawWidth = drawHeight * sourceRatio;
                                offsetX = (targetWidth - drawWidth) / 2;
                            }
                            canvas.width = targetWidth;
                            canvas.height = targetHeight;
                            ctx.fillStyle = '#f0f0f0';
                            ctx.fillRect(0, 0, targetWidth, targetHeight);
                        }
                        
                        // 高品質リサイズ設定
                        ctx.imageSmoothingEnabled = true;
                        ctx.imageSmoothingQuality = 'high';
                        
                        // 画像描画
                        ctx.drawImage(img, offsetX, offsetY, drawWidth, drawHeight);
                        
                        // 色処理を条件付きで適用
                        if (applyColorProcessing === 'grayscale') {
                            this.applyGrayscaleProcessing(ctx, targetWidth, targetHeight);
                        } else if (applyColorProcessing === true) {
                            this.applyColorProcessing(ctx, targetWidth, targetHeight);
                        }
                        
                        // 最適化されたDataURLを生成
                        const optimizedDataUrl = canvas.toDataURL('image/jpeg', quality);
                        
                        // 元の画像要素に適用
                        imgElement.src = optimizedDataUrl;
                        imgElement.style.opacity = '1';
                        
                        console.log(`🖼️ Auto-resized: ${img.width}x${img.height} → ${targetWidth}x${targetHeight}`);
                        
                    } catch (error) {
                        // Canvas処理に失敗した場合は元画像を直接表示
                        console.log('⚠️ Auto-resize failed, using original image:', error);
                        imgElement.src = src;
                        imgElement.style.opacity = '1';
                    }
                };
                
                img.onerror = () => {
                    // 画像読み込み失敗時
                    console.log('❌ Image load failed:', src);
                    imgElement.style.opacity = '1';
                };
                
                img.src = src;
            }

            // ほぼグレースケール処理を適用（ミニギャラリー用）
            applyGrayscaleProcessing(ctx, width, height) {
                try {
                    // 画像データを取得
                    const imageData = ctx.getImageData(0, 0, width, height);
                    const data = imageData.data;
                    
                    // ピクセルごとに処理
                    for (let i = 0; i < data.length; i += 4) {
                        const r = data[i];
                        const g = data[i + 1];
                        const b = data[i + 2];
                        
                        // 輝度ベースのグレースケール計算
                        const luminance = 0.299 * r + 0.587 * g + 0.114 * b;
                        
                        // ほぼグレースケール（わずかに元の色を残す）
                        const colorRetention = 0.15; // 15%の色を残す
                        const grayRetention = 0.85;   // 85%をグレースケール
                        
                        data[i]     = Math.round(luminance * grayRetention + r * colorRetention);
                        data[i + 1] = Math.round(luminance * grayRetention + g * colorRetention);
                        data[i + 2] = Math.round(luminance * grayRetention + b * colorRetention);
                        
                        // アルファ値はそのまま
                        // data[i + 3] はそのまま
                    }
                    
                    // 処理済み画像データを適用
                    ctx.putImageData(imageData, 0, 0);
                    
                } catch (error) {
                    console.log('⚠️ Grayscale processing skipped:', error.message);
                }
            }

            // ミニギャラリーのホバーエフェクトを設定（グレースケール⇄オリジナル色）
            setupMiniGalleryHoverEffect(imgElement, photoSrc) {
                let grayscaleImageSrc = null;
                let originalColorSrc = null;
                let isHovering = false;

                // ホバー開始時（グレースケール → オリジナル色）
                imgElement.addEventListener('mouseenter', async () => {
                    if (isHovering) return;
                    isHovering = true;

                    // グレースケール画像を保存（現在表示中）
                    if (!grayscaleImageSrc) {
                        grayscaleImageSrc = imgElement.src;
                    }

                    // オリジナル色画像をバックグラウンドで生成
                    if (!originalColorSrc) {
                        try {
                            originalColorSrc = await this.generateProcessedImage(photoSrc, {
                                targetWidth: 120,
                                targetHeight: 90,
                                quality: 0.7,
                                applyColorProcessing: false  // ホバー時はオリジナル色
                            });
                        } catch (error) {
                            console.log('ホバー用オリジナル色画像の生成に失敗:', error);
                            return;
                        }
                    }

                    // ホバー中であればオリジナル色画像に切り替え
                    if (isHovering && originalColorSrc) {
                        imgElement.src = originalColorSrc;
                    }
                });

                // ホバー終了時（オリジナル色 → グレースケール）
                imgElement.addEventListener('mouseleave', () => {
                    isHovering = false;
                    if (grayscaleImageSrc) {
                        imgElement.src = grayscaleImageSrc;
                    }
                });
            }

            // プロセス済み画像を生成（ホバーエフェクト用）
            generateProcessedImage(src, options) {
                return new Promise((resolve, reject) => {
                    const {
                        targetWidth = 120,
                        targetHeight = 90,
                        quality = 0.7,
                        applyColorProcessing = true
                    } = options;

                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    
                    img.onload = () => {
                        try {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            
                            canvas.width = targetWidth;
                            canvas.height = targetHeight;
                            
                            // アスペクト比計算とcover処理
                            const sourceRatio = img.width / img.height;
                            const targetRatio = targetWidth / targetHeight;
                            
                            let drawWidth, drawHeight, offsetX = 0, offsetY = 0;
                            
                            if (sourceRatio > targetRatio) {
                                drawHeight = targetHeight;
                                drawWidth = drawHeight * sourceRatio;
                                offsetX = (targetWidth - drawWidth) / 2;
                            } else {
                                drawWidth = targetWidth;
                                drawHeight = drawWidth / sourceRatio;
                                offsetY = (targetHeight - drawHeight) / 2;
                            }
                            
                            ctx.drawImage(img, offsetX, offsetY, drawWidth, drawHeight);
                            
                            // 色処理を適用
                            if (applyColorProcessing === 'grayscale') {
                                this.applyGrayscaleProcessing(ctx, targetWidth, targetHeight);
                            } else if (applyColorProcessing === true) {
                                this.applyColorProcessing(ctx, targetWidth, targetHeight);
                            }
                            
                            // DataURLを生成
                            const processedDataUrl = canvas.toDataURL('image/jpeg', quality);
                            resolve(processedDataUrl);
                            
                        } catch (error) {
                            reject(error);
                        }
                    };
                    
                    img.onerror = () => reject(new Error('Image load failed'));
                    img.src = src;
                });
            }

            // 基本的な色処理を適用（メイン画像用）
            applyColorProcessing(ctx, width, height) {
                try {
                    // この関数は主にメイン画像用。ミニギャラリーにはapplyGrayscaleProcessingを使用
                    console.log('🎨 Color processing applied (basic implementation)');
                } catch (error) {
                    console.log('⚠️ Color processing skipped:', error.message);
                }
            }

            // サムネイル生成関数
            generateThumbnail(src, width = 120, height = 90, quality = 0.7) {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    
                    img.onload = () => {
                        try {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            
                            canvas.width = width;
                            canvas.height = height;
                            
                            // アスペクト比計算とcover処理
                            const sourceRatio = img.width / img.height;
                            const targetRatio = width / height;
                            
                            let drawWidth, drawHeight, offsetX = 0, offsetY = 0;
                            
                            if (sourceRatio > targetRatio) {
                                drawHeight = height;
                                drawWidth = drawHeight * sourceRatio;
                                offsetX = (width - drawWidth) / 2;
                            } else {
                                drawWidth = width;
                                drawHeight = drawWidth / sourceRatio;
                                offsetY = (height - drawHeight) / 2;
                            }
                            
                            ctx.drawImage(img, offsetX, offsetY, drawWidth, drawHeight);
                            
                            // サムネイル用データURLを生成
                            const thumbnailDataUrl = canvas.toDataURL('image/jpeg', quality);
                            resolve(thumbnailDataUrl);
                            
                        } catch (error) {
                            console.log('⚠️ Thumbnail generation failed:', error);
                            resolve(src); // フォールバックで元画像を使用
                        }
                    };
                    
                    img.onerror = () => {
                        console.log('❌ Thumbnail image load failed');
                        resolve(src); // フォールバックで元画像を使用
                    };
                    
                    img.src = src;
                });
            }

            // 手動でフォルダをチェック（開発時用）
            async checkPhotoFolders() {
                console.log('📁 Photo folder structure:');
                console.log('   /photos/miiko/ <- みーこの写真をここに配置');
                console.log('   /photos/gallery/ <- ギャラリー写真をここに配置');
                console.log('');
                console.log('📄 Supported formats: .jpg, .jpeg, .png, .gif, .webp');
                console.log('🔧 Auto-resize: ANY size → optimized display size');
                console.log('📐 Main photos: Auto-resized to 800x1200 (portrait)');
                console.log('🖼️ Gallery photos: Auto-resized to 300x200 (landscape)');
                console.log('💡 Tip: Upload any size - system handles optimization automatically!');
            }
        }

        // 📤 ImageDropHandler Integration - 管理者認証付きドラッグ&ドロップ機能
        class ImageDropHandler {
            constructor(photoManager) {
                this.photoManager = photoManager;
                this.isAdminMode = false;
                this.adminPassword = 'sogoods2024'; // 本番では変更してください
                this.keySequence = [];
                this.secretKeys = ['s', 'o', 'g', 'o', 'o', 'd', 's']; // sogoods
                this.setupKeyListener();
                this.setupAuthSystem();
                this.checkDropPermission();
            }

            // キーシーケンス監視（簡素化）
            setupKeyListener() {
                document.addEventListener('keydown', (e) => {
                    // 秘密のキーシーケンス 'sogoods' 監視（緊急用）
                    this.keySequence.push(e.key.toLowerCase());
                    if (this.keySequence.length > this.secretKeys.length) {
                        this.keySequence.shift();
                    }

                    if (this.keySequence.join('') === this.secretKeys.join('')) {
                        console.log('🔑 Emergency key sequence detected!');
                        this.showAdminPrompt();
                        this.keySequence = [];
                    }
                });
            }

            // 管理者認証システム
            setupAuthSystem() {
                // 管理者モード表示インジケータを追加
                this.createAdminIndicator();
                
                // 隠しログインボタンを追加
                this.createHiddenLoginButton();
                
                // localStorage から認証状態を復元
                const savedAuth = localStorage.getItem('sogoods_admin_session');
                if (savedAuth) {
                    const session = JSON.parse(savedAuth);
                    const now = new Date().getTime();
                    
                    // セッションが24時間以内なら自動ログイン
                    if (now - session.timestamp < 24 * 60 * 60 * 1000) {
                        this.isAdminMode = true;
                        this.updateAdminIndicator();
                        console.log('🔐 Admin session restored');
                    }
                }
            }

            // 管理者プロンプト表示
            showAdminPrompt() {
                if (this.isAdminMode) {
                    // すでに管理者モードの場合はログアウト
                    this.logout();
                    return;
                }

                const password = prompt('🔐 管理者パスワードを入力してください:\n\n💡 ヒント: Ctrl+Shift+A または "sogoods" キーシーケンスでも開けます');
                
                if (password === this.adminPassword) {
                    this.login();
                } else if (password !== null) {
                    alert('❌ パスワードが違います');
                    console.log('🚫 Admin authentication failed');
                }
            }

            // ログイン処理
            login() {
                this.isAdminMode = true;
                
                // セッション保存（24時間）
                const session = {
                    timestamp: new Date().getTime(),
                    user: 'admin'
                };
                localStorage.setItem('sogoods_admin_session', JSON.stringify(session));
                
                this.setupDropZones();
                this.updateAdminIndicator();
                
                console.log('✅ Admin mode activated');
                console.log('📤 Drag & Drop enabled for photo upload');
                alert('✅ 管理者モードが有効になりました！\n📤 写真のドラッグ&ドロップが可能です');
            }

            // ログアウト処理
            logout() {
                this.isAdminMode = false;
                localStorage.removeItem('sogoods_admin_session');
                
                this.removeDropZones();
                this.updateAdminIndicator();
                
                console.log('🔒 Admin mode deactivated');
                alert('🔒 管理者モードを終了しました');
            }

            // 隠し管理者ボタンの作成
            createAdminIndicator() {
                // メインの管理者ステータス表示
                const indicator = document.createElement('div');
                indicator.id = 'admin-indicator';
                indicator.style.cssText = `
                    position: fixed;
                    top: 10px;
                    right: 10px;
                    background: rgba(0,0,0,0.8);
                    color: white;
                    padding: 8px 12px;
                    border-radius: 20px;
                    font-size: 12px;
                    font-family: Arial, sans-serif;
                    z-index: 1000;
                    display: none;
                    cursor: pointer;
                    transition: all 0.3s ease;
                `;
                
                indicator.onclick = () => this.showAdminPrompt();
                document.body.appendChild(indicator);
                this.adminIndicator = indicator;
            }

            // 隠しログインボタンの作成
            createHiddenLoginButton() {
                const hiddenButton = document.createElement('div');
                hiddenButton.id = 'hidden-admin-btn';
                hiddenButton.style.cssText = `
                    position: fixed;
                    bottom: 10px;
                    left: 10px;
                    width: 20px;
                    height: 20px;
                    background: rgba(200, 200, 200, 0.1);
                    border-radius: 50%;
                    cursor: pointer;
                    z-index: 1000;
                    transition: all 0.2s ease;
                    opacity: 0.1;
                    border: 1px solid rgba(200, 200, 200, 0.2);
                `;
                
                // ホバー時に少し目立つように
                hiddenButton.addEventListener('mouseenter', () => {
                    hiddenButton.style.opacity = '0.4';
                    hiddenButton.style.background = 'rgba(33, 150, 243, 0.3)';
                    hiddenButton.style.transform = 'scale(1.2)';
                });
                
                hiddenButton.addEventListener('mouseleave', () => {
                    hiddenButton.style.opacity = '0.1';
                    hiddenButton.style.background = 'rgba(200, 200, 200, 0.1)';
                    hiddenButton.style.transform = 'scale(1)';
                });
                
                // クリックで管理者ログイン
                hiddenButton.addEventListener('click', () => {
                    this.showAdminPrompt();
                });
                
                // ダブルクリックで更にわかりやすく
                hiddenButton.addEventListener('dblclick', (e) => {
                    e.preventDefault();
                    hiddenButton.style.background = 'rgba(33, 150, 243, 0.8)';
                    setTimeout(() => {
                        hiddenButton.style.background = 'rgba(200, 200, 200, 0.1)';
                    }, 200);
                });
                
                // ツールチップ（ホバー時のヒント）
                hiddenButton.title = 'Admin';
                
                document.body.appendChild(hiddenButton);
                this.hiddenButton = hiddenButton;
            }

            // インジケータ更新
            updateAdminIndicator() {
                if (!this.adminIndicator) return;
                
                // ストレージタイプの表示
                const storageType = this.photoManager.serverStorageEnabled ? '📁 Server Storage' : '💾 Browser Storage';
                
                if (this.isAdminMode) {
                    this.adminIndicator.innerHTML = `🔓 管理者モード (${storageType}) | クリックでログアウト`;
                    this.adminIndicator.style.display = 'block';
                    this.adminIndicator.style.background = 'rgba(33, 150, 243, 0.9)';
                    
                    // 隠しボタンも管理者モード表示に
                    if (this.hiddenButton) {
                        this.hiddenButton.style.background = 'rgba(33, 150, 243, 0.4)';
                        this.hiddenButton.style.opacity = '0.6';
                        this.hiddenButton.title = `Admin (${storageType}) - Click to logout`;
                    }
                } else {
                    this.adminIndicator.innerHTML = `🔐 左下の隠しボタンで管理者ログイン (${storageType})`;
                    this.adminIndicator.style.display = 'block';
                    this.adminIndicator.style.background = 'rgba(0,0,0,0.6)';
                    
                    // 隠しボタンを通常状態に
                    if (this.hiddenButton) {
                        this.hiddenButton.style.background = 'rgba(200, 200, 200, 0.1)';
                        this.hiddenButton.style.opacity = '0.1';
                        this.hiddenButton.title = `Admin Login (${storageType})`;
                    }
                    
                    // 5秒後に非表示
                    setTimeout(() => {
                        if (!this.isAdminMode) {
                            this.adminIndicator.style.display = 'none';
                        }
                    }, 3000);
                }
            }

            // ドロップ権限チェック
            checkDropPermission() {
                if (!this.isAdminMode) {
                    console.log('🔒 Drop功能已禁用 - 需要管理员权限');
                    return;
                }
                this.setupDropZones();
            }

            setupDropZones() {
                if (!this.isAdminMode) return;
                
                // メイン画像エリアをドロップゾーンに
                const centerColumn = document.querySelector('.center-column');
                if (centerColumn) {
                    // イベントリスナーが重複しないよう一度削除
                    this.removeDropZones();
                    
                    // ハンドラーをバインドして保存
                    this.boundHandlers = {
                        dragOver: this.handleDragOver.bind(this),
                        drop: this.handleDrop.bind(this),
                        dragEnter: this.handleDragEnter.bind(this),
                        dragLeave: this.handleDragLeave.bind(this)
                    };
                    
                    // イベントリスナーを追加
                    centerColumn.addEventListener('dragover', this.boundHandlers.dragOver);
                    centerColumn.addEventListener('drop', this.boundHandlers.drop);
                    centerColumn.addEventListener('dragenter', this.boundHandlers.dragEnter);
                    centerColumn.addEventListener('dragleave', this.boundHandlers.dragLeave);
                    
                    // 視覚的な管理者モード表示
                    centerColumn.style.position = 'relative';
                    
                    // 管理者オーバーレイの追加
                    if (!centerColumn.querySelector('.admin-overlay')) {
                        const overlay = document.createElement('div');
                        overlay.className = 'admin-overlay';
                        overlay.style.cssText = `
                            position: absolute;
                            top: 10px;
                            left: 10px;
                            background: rgba(33, 150, 243, 0.9);
                            color: white;
                            padding: 6px 10px;
                            border-radius: 12px;
                            font-size: 11px;
                            font-family: Arial, sans-serif;
                            z-index: 6;
                            pointer-events: none;
                        `;
                        overlay.textContent = '📤 Admin: Drop enabled';
                        centerColumn.appendChild(overlay);
                    }
                    
                    console.log('✅ Drop zones setup completed');
                }
            }

            removeDropZones() {
                const centerColumn = document.querySelector('.center-column');
                if (centerColumn) {
                    // 既存のイベントリスナーを削除（より安全な方法）
                    if (this.boundHandlers) {
                        centerColumn.removeEventListener('dragover', this.boundHandlers.dragOver);
                        centerColumn.removeEventListener('drop', this.boundHandlers.drop);
                        centerColumn.removeEventListener('dragenter', this.boundHandlers.dragEnter);
                        centerColumn.removeEventListener('dragleave', this.boundHandlers.dragLeave);
                    }
                    
                    // 管理者オーバーレイを削除
                    const overlay = centerColumn.querySelector('.admin-overlay');
                    if (overlay) overlay.remove();
                    
                    // スタイルリセット
                    centerColumn.style.backgroundColor = '';
                }
            }

            handleDragOver(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'copy';
            }

            handleDragEnter(e) {
                if (!this.isAdminMode) {
                    console.log('🔒 Drop disabled - Admin login required');
                    return;
                }
                
                e.preventDefault();
                e.target.style.backgroundColor = 'rgba(33, 150, 243, 0.1)';
                console.log('🎯 Admin drop zone activated - ready for image upload');
            }

            handleDragLeave(e) {
                e.target.style.backgroundColor = '';
            }

            async handleDrop(e) {
                console.log('🎯 Drop event triggered!', {
                    isAdminMode: this.isAdminMode,
                    filesCount: e.dataTransfer?.files?.length || 0
                });
                
                if (!this.isAdminMode) {
                    console.log('🔒 Drop blocked - Admin authentication required');
                    alert('🔒 管理者認証が必要です\n\nCtrl+Shift+A または "sogoods" と入力してログインしてください');
                    return;
                }

                e.preventDefault();
                e.target.style.backgroundColor = '';
                
                const files = Array.from(e.dataTransfer.files);
                const imageFiles = files.filter(file => file.type.startsWith('image/'));
                
                console.log('📁 Files analysis:', {
                    totalFiles: files.length,
                    imageFiles: imageFiles.length,
                    fileTypes: files.map(f => f.type)
                });
                
                if (imageFiles.length === 0) {
                    console.log('❌ No image files found in drop');
                    alert('❌ 画像ファイルが見つかりません\n対応形式: JPG, PNG, GIF, WebP');
                    return;
                }

                console.log(`📤 Admin processing ${imageFiles.length} dropped image(s)`);
                alert(`📤 ${imageFiles.length}枚の画像を処理中...`);

                for (const file of imageFiles) {
                    await this.processDroppedImage(file);
                }
                
                alert('✅ 画像アップロード完了！新しい写真がランダム表示に追加されました。');
                
                // アップロード後、少し待ってからランダム表示を更新
                setTimeout(() => {
                    this.photoManager.displayRandomPhoto();
                }, 1000);
            }

            async processDroppedImage(file) {
                console.log(`🔄 Processing image: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)}MB)`);
                
                // 従来のブラウザベース処理
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    
                    reader.onload = (e) => {
                        console.log('📖 File read successfully, creating image...');
                        const img = new Image();
                        img.onload = () => {
                            console.log(`🖼️ Image loaded: ${img.width}x${img.height}`);
                            
                            // アップロードされた写真をランダム表示に追加
                            this.photoManager.addUploadedPhoto(e.target.result, file.name);
                            
                            // 自動リサイズして表示
                            const mainImage = document.querySelector('.main-image');
                            if (mainImage) {
                                this.photoManager.loadImageWithAutoResize(e.target.result, mainImage, {
                                    targetWidth: 800,
                                    targetHeight: 1200,
                                    quality: 0.8
                                });
                                
                                console.log(`✅ Processed: ${file.name} (${img.width}x${img.height})`);
                            } else {
                                console.error('❌ Main image element not found');
                            }
                            resolve();
                        };
                        
                        img.onerror = () => {
                            console.error(`❌ Failed to load image: ${file.name}`);
                            resolve();
                        };
                        
                        img.src = e.target.result;
                    };
                    
                    reader.onerror = () => {
                        console.error(`❌ Failed to read file: ${file.name}`);
                        resolve();
                    };
                    
                    reader.readAsDataURL(file);
                });
            }
        }

        // グローバルに公開
        window.PhotoManager = PhotoManager;
        window.ImageDropHandler = ImageDropHandler;

        // 📝 TankaSystem Integration - sogoods.net Advanced Tanka System
        /**
         * sogoods.net Advanced Tanka System
         * CSV Database Integration + Vertical Display + Voting System
         */

        class TankaSystem {
            constructor() {
                this.tankaDatabase = [];
                this.votingResults = new Map(); // tankaId -> {likes: 0, dislikes: 0}
                this.currentTankaIndex = 0;
                this.isInitialized = false;
                
                this.init();
            }

            async init() {
                console.log('📝 Initializing Advanced Tanka System...');
                
                try {
                    await this.loadTankaDatabase();
                    await this.loadVotingResults();
                    this.isInitialized = true;
                    console.log(`✅ Tanka system ready with ${this.tankaDatabase.length} poems`);
                } catch (error) {
                    console.error('❌ Tanka system initialization failed:', error);
                    this.fallbackToStaticTanka();
                }
            }

            // CSV データベースを読み込み
            async loadTankaDatabase() {
                try {
                    const response = await fetch('/tankadb.csv');
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const csvText = await response.text();
                    this.tankaDatabase = this.parseCSV(csvText);
                    
                    console.log(`📚 Loaded ${this.tankaDatabase.length} tanka from CSV database`);
                    console.log('📊 Sample tanka:', this.tankaDatabase.slice(0, 3));
                    
                } catch (error) {
                    console.error('❌ Failed to load tanka CSV:', error);
                    throw error;
                }
            }

            // CSVパーサー
            parseCSV(csvText) {
                const lines = csvText.split('\n').filter(line => line.trim());
                const header = lines[0].split(',');
                const tanka = [];
                
                for (let i = 1; i < lines.length; i++) {
                    const columns = this.parseCSVLine(lines[i]);
                    if (columns.length >= 3) {
                        tanka.push({
                            id: i,
                            text: columns[0].trim(),
                            date: columns[1].trim(),
                            rating: parseInt(columns[2]) || 0,
                            votes: { likes: 0, dislikes: 0 }
                        });
                    }
                }
                
                return tanka;
            }

            // CSV行パーサー（カンマが短歌内に含まれる場合に対応）
            parseCSVLine(line) {
                const result = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current);
                        current = '';
                    } else {
                        current += char;
                    }
                }
                
                result.push(current);
                return result;
            }

            // 投票結果を読み込み（サーバーから）
            async loadVotingResults() {
                try {
                    const response = await fetch('/api/tanka-vote');
                    if (response.ok) {
                        const results = await response.json();
                        if (results.success) {
                            results.votes.forEach(vote => {
                                this.votingResults.set(vote.tankaId, {
                                    likes: vote.likes || 0,
                                    dislikes: vote.dislikes || 0
                                });
                            });
                            console.log(`📊 Loaded voting results for ${this.votingResults.size} tanka`);
                        }
                    }
                } catch (error) {
                    console.log('⚠️ No voting results found (will start fresh)');
                }
            }

            // フォールバック用の静的短歌
            fallbackToStaticTanka() {
                console.log('🔄 Using fallback static tanka collection');
                this.tankaDatabase = [
                    { id: 1, text: "冬の朝窓辺に座る猫の瞳静寂を映し時が止まる", date: "2024-01-01", rating: 4 },
                    { id: 2, text: "桜散り風に舞い踊る花びらよ心に残る春の記憶", date: "2024-01-02", rating: 5 },
                    { id: 3, text: "夕暮れに街灯が点く道すがら影が長くて家路急ぐ", date: "2024-01-03", rating: 3 }
                ];
                this.isInitialized = true;
            }

            // ランダムな短歌を取得
            getRandomTanka() {
                if (!this.isInitialized || this.tankaDatabase.length === 0) {
                    return null;
                }
                
                const randomIndex = Math.floor(Math.random() * this.tankaDatabase.length);
                this.currentTankaIndex = randomIndex;
                return this.tankaDatabase[randomIndex];
            }

            // 縦書き短歌ポップアップを表示
            displayVerticalTanka(tankaData, element) {
                // 既存のポップアップを削除
                const existingPopup = document.querySelector('.tanka-popup');
                if (existingPopup) {
                    existingPopup.remove();
                }

                // エモーショナルな解説を生成
                const commentary = this.generateEmotionalCommentary(tankaData.text);

                const popup = document.createElement('div');
                popup.className = 'tanka-popup';
                popup.innerHTML = `
                    <div class="tanka-popup-content">
                        <div class="tanka-close-btn" onclick="this.closest('.tanka-popup').remove()">×</div>
                        <div class="tanka-vertical-text">${this.createVerticalText(tankaData.text)}</div>
                        <div class="tanka-commentary">
                            ${commentary}
                        </div>
                        <div class="tanka-voting">
                            <button class="vote-btn like-btn" onclick="window.tankaSystem.voteTanka(${tankaData.id}, 'like', this)">
                                👍 いいね <span class="vote-count">${this.getVotes(tankaData.id).likes}</span>
                            </button>
                            <button class="vote-btn dislike-btn" onclick="window.tankaSystem.voteTanka(${tankaData.id}, 'dislike', this)">
                                👎 う〜ん <span class="vote-count">${this.getVotes(tankaData.id).dislikes}</span>
                            </button>
                        </div>
                    </div>
                    <div class="tanka-popup-overlay" onclick="this.closest('.tanka-popup').remove()"></div>
                `;

                document.body.appendChild(popup);

                // アニメーション
                requestAnimationFrame(() => {
                    popup.classList.add('show');
                });

                console.log(`📝 Displaying tanka with commentary: "${tankaData.text.substring(0, 20)}..."`);
            }

            // 木下龍也・俵万智スタイルのエモーショナルな解説を生成
            generateEmotionalCommentary(tankaText) {
                console.log(`🔍 Analyzing tanka: "${tankaText}"`);
                
                // より一般的なテーマパターン
                const generalPatterns = [
                    {
                        pattern: /笑.*不思議|ふしぎ.*笑/,
                        style: "笑いの不思議さ。なぜその瞬間に笑みがこぼれるのか、理由はわからないけれど確かにある温かさ。"
                    },
                    {
                        pattern: /神.*参り|かみさま.*きもち/,
                        style: "神様に向き合う時の、言葉にならない気持ち。理屈じゃない、心の奥底からの素直な思い。"
                    },
                    {
                        pattern: /子.*髪.*なで|さむしい.*子/,
                        style: "子どもへの優しさが、髪をなでる手のひらに込められている。言葉以上に伝わる愛情。"
                    },
                    {
                        pattern: /生きる.*信じる/,
                        style: "生きることと信じること。この二つは切っても切れない関係。信じる力があるから生きていける。"
                    },
                    {
                        pattern: /芽.*花.*育て/,
                        style: "今は小さな芽でも、大切に育てればいつか花を咲かせる。成長への希望と愛情。"
                    },
                    {
                        pattern: /夢.*楽し.*道/,
                        style: "夢への道のりを楽しむ心。目的地よりも、歩いている今この時間を大切にする生き方。"
                    },
                    {
                        pattern: /冬.*春.*ほしい/,
                        style: "厳しい冬を経験したからこそ、春への憧れが深い。困難の後に来る希望への切実な願い。"
                    },
                    {
                        pattern: /窓.*雨.*水|雨.*まかせる/,
                        style: "窓辺の雨を見つめる時間。自然に身を任せる心の静けさ。コントロールできないものへの信頼。"
                    }
                ];

                // パターンをチェック
                for (let pattern of generalPatterns) {
                    if (pattern.pattern.test(tankaText)) {
                        console.log(`✅ Matched pattern: ${pattern.pattern}`);
                        return pattern.style;
                    }
                }

                // キーワードベースの解説生成
                return this.generateKeywordBasedCommentary(tankaText);
            }

            // キーワードベースの解説生成
            generateKeywordBasedCommentary(tankaText) {
                const keywords = [];
                
                // 感情キーワード
                if (/嬉し|楽し|幸せ|よろこ/.test(tankaText)) keywords.push('joy');
                if (/悲し|泣|涙|辛|苦し/.test(tankaText)) keywords.push('sadness');
                if (/愛|恋|好き|恋人/.test(tankaText)) keywords.push('love');
                if (/不安|心配|怖|恐/.test(tankaText)) keywords.push('anxiety');
                if (/懐かし|思い出|昔/.test(tankaText)) keywords.push('nostalgia');
                
                // 自然・季節キーワード
                if (/春|桜|花|芽/.test(tankaText)) keywords.push('spring');
                if (/夏|暑|海|陽/.test(tankaText)) keywords.push('summer');
                if (/秋|紅葉|風|落ち葉/.test(tankaText)) keywords.push('autumn');
                if (/冬|雪|寒|氷/.test(tankaText)) keywords.push('winter');
                if (/雨|雲|空|虹/.test(tankaText)) keywords.push('weather');
                
                // 人間関係キーワード
                if (/家族|母|父|子|親/.test(tankaText)) keywords.push('family');
                if (/友|仲間|みんな/.test(tankaText)) keywords.push('friendship');
                if (/一人|独り|孤独|ひとり/.test(tankaText)) keywords.push('solitude');
                
                // 時間キーワード
                if (/過去|昔|思い出|前/.test(tankaText)) keywords.push('past');
                if (/未来|明日|希望|将来/.test(tankaText)) keywords.push('future');
                if (/今|瞬間|現在|いま/.test(tankaText)) keywords.push('present');

                // キーワードに基づいた解説
                const commentaryMap = {
                    joy: "この歌に込められた喜びが、読む人の心も明るくしてくれる。幸せって、こうやって人から人へ伝わっていくもの。",
                    sadness: "悲しみを丁寧に言葉にすることで、その感情に向き合おうとする強さを感じる。涙の向こう側にある希望。",
                    love: "愛情を短歌に込める時の、その人への想いの深さ。言葉を選ぶ一つ一つに、愛が宿っている。",
                    anxiety: "不安な気持ちも、こうして歌にすることで少し軽くなる。一人じゃないよ、という声が聞こえてくる。",
                    nostalgia: "懐かしさに包まれながら、過去の自分と今の自分が対話している。時間を超えた心の交流。",
                    spring: "春の訪れを心で感じ取る繊細さ。新しい季節への期待と希望が、言葉の端々に現れている。",
                    family: "家族への愛情が、何気ない日常の描写に込められている。当たり前の幸せを大切にする心。",
                    solitude: "一人の時間だからこそ見えてくる景色がある。孤独の中にある豊かさを発見する眼差し。",
                    present: "今この瞬間を大切に捉える気持ち。過ぎ去ってしまう時間への愛おしさ。"
                };

                if (keywords.length > 0) {
                    const primaryKeyword = keywords[0];
                    console.log(`🎯 Generated commentary based on keyword: ${primaryKeyword}`);
                    return commentaryMap[primaryKeyword] || this.getDefaultCommentary();
                }

                return this.getDefaultCommentary();
            }

            // デフォルト解説
            getDefaultCommentary() {
                const defaults = [
                    "短い言葉の中に、深い想いが込められている。読むたびに新しい発見がある、そんな一首。",
                    "日常の中の小さな気づきを、大切に言葉に込めた歌。作者の優しい眼差しが感じられる。",
                    "この歌を読んでいると、自分の体験と重なる部分があって、心が動かされる。",
                    "言葉と言葉の間にある余白に、読み手の想像が広がっていく。短歌の魅力を感じる一首。",
                    "作者の心の動きが、そのまま読み手に伝わってくる。素直な感情表現が印象的。"
                ];
                
                return defaults[Math.floor(Math.random() * defaults.length)];
            }

            // 縦書きテキストを生成
            createVerticalText(text) {
                const characters = text.split('');
                return characters.map(char => `<span class="vertical-char">${char}</span>`).join('');
            }

            // 投票数を取得
            getVotes(tankaId) {
                return this.votingResults.get(tankaId) || { likes: 0, dislikes: 0 };
            }

            // 短歌に投票
            async voteTanka(tankaId, voteType, buttonElement) {
                try {
                    console.log(`📊 Voting for tanka ${tankaId}: ${voteType}`);

                    const response = await fetch('/api/tanka-vote', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            tankaId: tankaId,
                            vote: voteType
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            // ローカル投票結果を更新
                            this.votingResults.set(tankaId, result.votes);
                            
                            // UI を更新
                            this.updateVotingUI(tankaId);
                            
                            // 視覚的フィードバック
                            buttonElement.classList.add('voted');
                            setTimeout(() => {
                                buttonElement.classList.remove('voted');
                            }, 300);

                            console.log(`✅ Vote recorded: ${voteType} for tanka ${tankaId}`);
                        } else {
                            throw new Error(result.error);
                        }
                    } else {
                        throw new Error(`Server error: ${response.status}`);
                    }

                } catch (error) {
                    console.error('❌ Vote failed:', error);
                    alert('投票に失敗しました。もう一度お試しください。');
                }
            }

            // 投票UI を更新
            updateVotingUI(tankaId) {
                const popup = document.querySelector('.tanka-popup');
                if (!popup) return;

                const votes = this.getVotes(tankaId);
                const likesCount = popup.querySelector('.like-btn .vote-count');
                const dislikesCount = popup.querySelector('.dislike-btn .vote-count');

                if (likesCount) likesCount.textContent = votes.likes;
                if (dislikesCount) dislikesCount.textContent = votes.dislikes;
            }

            // 統計情報を取得
            getStats() {
                return {
                    totalTanka: this.tankaDatabase.length,
                    totalVotes: Array.from(this.votingResults.values()).reduce((sum, votes) => sum + votes.likes + votes.dislikes, 0),
                    mostLiked: this.getMostLikedTanka(),
                    averageRating: this.getAverageRating()
                };
            }

            getMostLikedTanka() {
                let maxLikes = 0;
                let mostLiked = null;

                this.votingResults.forEach((votes, tankaId) => {
                    if (votes.likes > maxLikes) {
                        maxLikes = votes.likes;
                        mostLiked = this.tankaDatabase.find(t => t.id === tankaId);
                    }
                });

                return mostLiked;
            }

            getAverageRating() {
                if (this.tankaDatabase.length === 0) return 0;
                const sum = this.tankaDatabase.reduce((total, tanka) => total + tanka.rating, 0);
                return (sum / this.tankaDatabase.length).toFixed(1);
            }
        }

        // グローバルインスタンス
        window.tankaSystem = new TankaSystem();

        // 数字のランダムアニメーションシステム
        class NumberAnimationSystem {
            constructor() {
                this.numbers = document.querySelectorAll('.number');
                this.animationIntervals = [];
                this.init();
            }

            init() {
                console.log('🔢 Number Animation System initialized');
                this.startRandomAnimations();
            }

            startRandomAnimations() {
                this.numbers.forEach((number, index) => {
                    // 各数字に異なるランダム間隔を設定（よりゆっくり）
                    const randomDelay = Math.random() * 15000; // 0-15秒のランダム初期遅延
                    const animationInterval = 10000 + Math.random() * 25000; // 10-35秒のランダム間隔

                    setTimeout(() => {
                        this.animateNumber(number, index);
                        
                        // 継続的なランダムアニメーション
                        const interval = setInterval(() => {
                            this.animateNumber(number, index);
                        }, animationInterval);
                        
                        this.animationIntervals.push(interval);
                    }, randomDelay);
                });
            }

            animateNumber(number, index) {
                // ゆっくりした浮上アニメーション
                number.style.animation = 'numberFloat 2.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards';
                
                // 表示時間（5-10秒のランダム）
                const displayTime = 5000 + Math.random() * 5000;
                
                setTimeout(() => {
                    // ゆっくりした消失アニメーション
                    number.style.animation = 'numberFade 3s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards';
                    
                    setTimeout(() => {
                        number.style.animation = '';
                    }, 3000);
                }, displayTime);

                console.log(`💫 Number ${index + 1} slowly animated`);
            }
        }

        // メイン画像管理システム（簡素化版）
        class MainImageSystem {
            constructor() {
                this.mainImages = [
                    '129-DSCN9004.JPG',
                    '1758928793445-2D3DD0DA-ABA9-44F8-B090-558ADB3E9F42.jpeg',
                    '1758932572782-032-DSC_1023.JPG.jpg',
                    '21-DSC_2098.JPG',
                    '30-DSC_8602.JPG'
                ];
                this.baseUrl = 'https://sogoods.net/photos/main/';
                this.mainImageElement = document.getElementById('main-image');
                this.fallbackImages = [
                    'https://images.unsplash.com/photo-1533738363-b7f9aef128ce?w=800&h=600&fit=crop',
                    'https://images.unsplash.com/photo-1583336663277-620dc1996580?w=800&h=600&fit=crop',
                    'https://images.unsplash.com/photo-1571566882372-1598d88abd90?w=800&h=600&fit=crop'
                ];
                this.init();
            }

            init() {
                console.log('🖼️ Main Image System initialized');
                this.displayRandomImage();
                
                // 30秒ごとに画像を変更
                setInterval(() => {
                    this.displayRandomImage();
                }, 30000);
            }

            async displayRandomImage() {
                if (!this.mainImageElement) {
                    console.warn('⚠️ Main image element not found');
                    return;
                }

                const randomIndex = Math.floor(Math.random() * this.mainImages.length);
                const selectedImage = this.mainImages[randomIndex];
                const imageUrl = this.baseUrl + selectedImage;

                try {
                    // 画像の読み込みをテスト
                    const img = new Image();
                    img.onload = () => {
                        this.mainImageElement.src = imageUrl;
                        this.mainImageElement.alt = `sogoods photo`;
                        this.mainImageElement.style.display = 'block';
                        console.log(`✅ Main image loaded: ${selectedImage}`);
                    };
                    
                    img.onerror = () => {
                        console.warn(`❌ Failed to load: ${selectedImage}, using fallback`);
                        this.useFallbackImage();
                    };
                    
                    img.src = imageUrl;
                    
                } catch (error) {
                    console.error('❌ Image loading error:', error);
                    this.useFallbackImage();
                }
            }

            useFallbackImage() {
                const fallbackIndex = Math.floor(Math.random() * this.fallbackImages.length);
                const fallbackUrl = this.fallbackImages[fallbackIndex];
                
                this.mainImageElement.src = fallbackUrl;
                this.mainImageElement.alt = 'sogoods fallback image';
                this.mainImageElement.style.display = 'block';
                console.log(`🔄 Using fallback image: ${fallbackUrl}`);
            }
        }

        // DOM読み込み後に自動初期化
        document.addEventListener('DOMContentLoaded', () => {
            window.photoManager = new PhotoManager();
            window.imageDropHandler = new ImageDropHandler(window.photoManager);
            window.numberAnimationSystem = new NumberAnimationSystem();
            window.mainImageSystem = new MainImageSystem();
            
            // 開発時のヘルプ表示
            setTimeout(() => {
                window.photoManager.checkPhotoFolders();
                console.log('');
                console.log('🔐 ADMIN ACCESS:');
                console.log('   • Hidden button: Bottom-left corner (subtle gray circle)');
                console.log('   • Emergency: Type "sogoods" for backup access');
                console.log('   • Password: sogoods2024');
                console.log('   • Session: 24-hour auto-login after authentication');
                console.log('📱 Auto-resize: Upload ANY size - system optimizes automatically');
                console.log('🔒 Security: Only authenticated admins can upload photos');
            }, 2000);
        });
    </script>
</body>
</html>