name: Deploy to SoGoods.net

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy-to-sogoods:
    runs-on: ubuntu-latest
    
    steps:
    - name: Test SSH Connection
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: sogoodsnet.sakura.ne.jp
        username: sogoodsnet
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        timeout: 30s
        script: |
          echo "SSH Connection Test for SoGoods.net"
          whoami
          pwd
          echo "Deploy target: https://sogoods.net/"
          
    - name: Create Directory
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: sogoodsnet.sakura.ne.jp
        username: sogoodsnet
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        timeout: 30s
        script: mkdir -p /home/sogoodsnet/www
        
    - name: Download index.html
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: sogoodsnet.sakura.ne.jp
        username: sogoodsnet
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        timeout: 30s
        script: |
          cd /home/sogoodsnet/www
          curl -s -o index.html https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/index.html || fetch -q -o index.html https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/index.html
          
    - name: Download about.html
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: sogoodsnet.sakura.ne.jp
        username: sogoodsnet
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        timeout: 30s
        script: |
          cd /home/sogoodsnet/www
          curl -s -o about.html https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/about.html || fetch -q -o about.html https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/about.html
          
    - name: Download style.css
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: sogoodsnet.sakura.ne.jp
        username: sogoodsnet
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        timeout: 30s
        script: |
          cd /home/sogoodsnet/www
          curl -s -o style.css https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/style.css || fetch -q -o style.css https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/style.css
          
    - name: Set File Permissions
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: sogoodsnet.sakura.ne.jp
        username: sogoodsnet
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        timeout: 30s
        script: |
          cd /home/sogoodsnet/www
          chmod 644 *.html *.css 2>/dev/null || true
          
    - name: Verify Deployment
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: sogoodsnet.sakura.ne.jp
        username: sogoodsnet
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        timeout: 30s
        script: |
          echo "📋 Deployment verification for SoGoods.net"
          cd /home/sogoodsnet/www
          ls -la
          echo "✅ Files deployed to https://sogoods.net/"
          
    - name: Test Website
      run: |
        echo "🌐 Testing SoGoods.net website access..."
        sleep 10
        
        # HTTPステータス確認
        STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://sogoods.net/ 2>/dev/null || echo "000")
        echo "HTTP Status for https://sogoods.net/: $STATUS"
        
        if [ "$STATUS" = "200" ]; then
          echo "✅ SoGoods.net is accessible!"
        else
          echo "⚠️ SoGoods.net status: $STATUS"
        fi
        
    - name: Deployment Summary
      if: always()
      run: |
        echo "## 🌟 SoGoods.net Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ job.status }}" == "success" ]; then
          echo "- **Status**: ✅ Success" >> $GITHUB_STEP_SUMMARY
          echo "- **Method**: Direct file deployment to Sakura server" >> $GITHUB_STEP_SUMMARY
          echo "- **Files**: HTML, CSS deployed successfully" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **Status**: ❌ Failed during deployment" >> $GITHUB_STEP_SUMMARY
        fi
        echo "- **Live URL**: https://sogoods.net/" >> $GITHUB_STEP_SUMMARY
        echo "- **About Page**: https://sogoods.net/about.html" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 🎯 Your Site is Live!" >> $GITHUB_STEP_SUMMARY
        echo "Visit [SoGoods.net](https://sogoods.net/) to see your deployed site." >> $GITHUB_STEP_SUMMARY