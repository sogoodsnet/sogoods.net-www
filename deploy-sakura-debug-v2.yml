name: Deploy to Sakura Server (Debug v2)

on:
  workflow_dispatch:

jobs:
  debug-ssh-detailed:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Debug Environment
      run: |
        echo "ðŸ” GitHub Actionsç’°å¢ƒæƒ…å ±"
        echo "Runner OS: $(uname -a)"
        echo "SSH Client Version: $(ssh -V 2>&1)"
        echo "OpenSSL Version: $(openssl version)"
        
    - name: Debug SSH Key Format
      run: |
        echo "ðŸ”‘ SSHéµã®è©³ç´°ç¢ºèª"
        if [ -n "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
          echo "âœ… SSH_PRIVATE_KEY Secret ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™"
          echo "éµã®æœ€åˆã®è¡Œ:"
          echo "${{ secrets.SSH_PRIVATE_KEY }}" | head -1
          echo "éµã®æœ€å¾Œã®è¡Œ:"  
          echo "${{ secrets.SSH_PRIVATE_KEY }}" | tail -1
          echo "éµã®è¡Œæ•°:"
          echo "${{ secrets.SSH_PRIVATE_KEY }}" | wc -l
          echo "éµã®æ–‡å­—æ•°:"
          echo "${{ secrets.SSH_PRIVATE_KEY }}" | wc -c
        else
          echo "âŒ SSH_PRIVATE_KEY Secret ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
          exit 1
        fi
        
    - name: Test SSH Connection with Verbose
      run: |
        echo "ðŸ”§ SSHæŽ¥ç¶šãƒ†ã‚¹ãƒˆï¼ˆè©³ç´°ãƒ­ã‚°ä»˜ãï¼‰"
        
        # SSHéµã‚’ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > /tmp/ssh_key
        chmod 600 /tmp/ssh_key
        
        # SSHæŽ¥ç¶šãƒ†ã‚¹ãƒˆï¼ˆè©³ç´°ãƒ­ã‚°ï¼‰
        echo "SSHæŽ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹..."
        ssh -i /tmp/ssh_key \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            -o ConnectTimeout=30 \
            -v \
            sogoodsnet@sogoodsnet.sakura.ne.jp \
            'echo "SSHæŽ¥ç¶šæˆåŠŸ: $(date)" && whoami && pwd' || {
          echo "âŒ SSHæŽ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ"
          echo "ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰: $?"
        }
        
        # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
        rm -f /tmp/ssh_key
        
    - name: Alternative SSH Test with Different Options
      run: |
        echo "ðŸ”„ ä»£æ›¿SSHæŽ¥ç¶šã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ãƒ†ã‚¹ãƒˆ"
        
        # SSHéµã‚’ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > /tmp/ssh_key2
        chmod 600 /tmp/ssh_key2
        
        # ç•°ãªã‚‹SSHã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ãƒ†ã‚¹ãƒˆ
        ssh -i /tmp/ssh_key2 \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            -o PasswordAuthentication=no \
            -o PubkeyAuthentication=yes \
            -o ConnectTimeout=10 \
            -o ServerAliveInterval=10 \
            sogoodsnet@sogoodsnet.sakura.ne.jp \
            'echo "ä»£æ›¿æŽ¥ç¶šæˆåŠŸ"' || {
          echo "âŒ ä»£æ›¿SSHæŽ¥ç¶šã‚‚å¤±æ•—"
          
          # ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æŽ¥ç¶šç¢ºèª
          echo "ðŸŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æŽ¥ç¶šç¢ºèª"
          ping -c 3 sogoodsnet.sakura.ne.jp || echo "ping failed"
          nslookup sogoodsnet.sakura.ne.jp || echo "DNS resolution failed"
        }
        
        # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
        rm -f /tmp/ssh_key2
        
  ssh-action-test:
    runs-on: ubuntu-latest
    needs: debug-ssh-detailed
    if: always()
    
    steps:
    - name: Test with SSH Action (Debug Mode)
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: sogoodsnet.sakura.ne.jp
        username: sogoodsnet
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        timeout: 30s
        command_timeout: 30s
        debug: true
        script: |
          echo "ðŸŽ‰ SSH ActionæŽ¥ç¶šæˆåŠŸ!"
          echo "ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼: $(whoami)"
          echo "ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: $(pwd)"  
          echo "ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±: $(uname -a)"
          echo "ç¾åœ¨æ™‚åˆ»: $(date)"
          
          # ãƒ›ãƒ¼ãƒ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç¢ºèª
          echo "ãƒ›ãƒ¼ãƒ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: $HOME"
          ls -la $HOME
          
          # SSHè¨­å®šç¢ºèª
          echo "SSHè¨­å®š:"
          ls -la ~/.ssh/ 2>/dev/null || echo "~/.ssh not found"
          
          # æ¨©é™ç¢ºèª
          echo "authorized_keysæ¨©é™:"
          ls -la ~/.ssh/authorized_keys 2>/dev/null || echo "authorized_keys not found"
          
    - name: SSH Connection Summary
      if: always()
      run: |
        echo "## ðŸ” SSHæŽ¥ç¶šãƒ†ã‚¹ãƒˆçµæžœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ job.status }}" == "success" ]; then
          echo "- **SSH Action Status**: âœ… æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "- **æŽ¥ç¶šç¢ºèª**: SSHæŽ¥ç¶šãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **SSH Action Status**: âŒ å¤±æ•—" >> $GITHUB_STEP_SUMMARY
          echo "- **å¿…è¦ãªç¢ºèªäº‹é …**:" >> $GITHUB_STEP_SUMMARY
          echo "  1. SSH_PRIVATE_KEY Secretã®å†…å®¹ç¢ºèª" >> $GITHUB_STEP_SUMMARY
          echo "  2. Sakuraã‚µãƒ¼ãƒãƒ¼ã®authorized_keysç¢ºèª" >> $GITHUB_STEP_SUMMARY
          echo "  3. SSHéµãƒšã‚¢ã®å†ç”Ÿæˆ" >> $GITHUB_STEP_SUMMARY
        fi