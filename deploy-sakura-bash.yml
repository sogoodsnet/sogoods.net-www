name: Deploy to Sakura Server (Bash)

on:
  workflow_dispatch:

jobs:
  deploy-with-bash:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Deploy using Bash shell
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: sogoodsnet.sakura.ne.jp
        username: sogoodsnet
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        timeout: 60s
        command_timeout: 120s
        # Bashã‚·ã‚§ãƒ«ã‚’æ˜ç¤ºçš„ã«æŒ‡å®š
        script: |
          #!/bin/bash
          
          echo "ğŸš€ Bash deployment to Sakura server"
          echo "Shell: $0"
          echo "User: $(whoami)"
          echo "Date: $(date)"
          
          # Bashå¤‰æ•°å®šç¾©
          DEPLOY_PATH="/home/sogoodsnet/www"
          BACKUP_PATH="/home/sogoodsnet/backup/sogoods-backup-$(date +%Y%m%d-%H%M%S)"
          
          echo "ğŸ“‚ Deploy path: $DEPLOY_PATH"
          echo "ğŸ’¾ Backup path: $BACKUP_PATH"
          
          # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ
          mkdir -p "/home/sogoodsnet/backup"
          
          # æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
          if [[ -d "$DEPLOY_PATH" ]] && [[ -n "$(ls -A $DEPLOY_PATH 2>/dev/null)" ]]; then
            echo "ğŸ“¦ Creating backup..."
            mkdir -p "$BACKUP_PATH"
            cp -r "$DEPLOY_PATH"/* "$BACKUP_PATH/" 2>/dev/null || true
            echo "âœ… Backup created at: $BACKUP_PATH"
          fi
          
          # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æº–å‚™
          mkdir -p "$DEPLOY_PATH"
          cd "$DEPLOY_PATH"
          
          # Bashã®å ´æ‰€ã‚’ç¢ºèª
          which bash && echo "Bash available" || echo "Bash not found"
          
          # æ‰‹å‹•ã§ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆGitä½¿ã‚ãªã„ï¼‰
          echo "ğŸ“¥ Downloading files directly..."
          
          # curlã¾ãŸã¯wgetã§ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          if command -v curl >/dev/null 2>&1; then
            echo "Using curl for download"
            curl -s -L -o index.html https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/index.html
            curl -s -L -o about.html https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/about.html
            curl -s -L -o style.css https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/style.css
            curl -s -L -o README.md https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/README.md
          elif command -v fetch >/dev/null 2>&1; then
            echo "Using fetch for download"
            fetch -q https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/index.html
            fetch -q https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/about.html
            fetch -q https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/style.css
            fetch -q https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/README.md
          else
            echo "No download tool available"
            exit 1
          fi
          
          # ãƒ•ã‚¡ã‚¤ãƒ«æ¨©é™ã®è¨­å®š
          echo "ğŸ”§ Setting file permissions..."
          chmod 644 *.html *.css *.md 2>/dev/null || true
          chmod 755 . 2>/dev/null || true
          
          # çµæœç¢ºèª
          echo "ğŸ“‹ Deployed files:"
          ls -la
          
          # ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ç¢ºèª
          echo "ğŸ“„ Checking deployed content:"
          if [[ -f "index.html" ]]; then
            echo "âœ… index.html exists ($(wc -l < index.html) lines)"
          else
            echo "âŒ index.html missing"
          fi
          
          echo "âœ… Deployment completed successfully!"
          echo "ğŸŒ Site should be available at: https://sogoodsnet.sakura.ne.jp/"