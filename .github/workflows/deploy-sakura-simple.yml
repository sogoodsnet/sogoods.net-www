name: Deploy Complete Website to Sakura Server

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - '*.html'
      - '*.css'
      - '*.js'
      - '*.php'
      - '*.csv'
      - '*.json'
      - '*.md'
      - '.htaccess'
      - 'assets/**'
      - 'functions/**'
      - 'img/**'
      - 'photos/**'

jobs:
  complete-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Complete Website Deployment to FreeBSD
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: sogoodsnet.sakura.ne.jp
        username: sogoodsnet
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        timeout: 60s
        script: |
          echo "ðŸš€ Complete Website Deployment to FreeBSD"
          
          # åŸºæœ¬æƒ…å ±ç¢ºèª
          echo "User: `whoami`"
          echo "Home: $HOME"
          echo "Shell: $SHELL"
          echo "Date: `date`"
          
          # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆï¼ˆåŸºæœ¬ç‰ˆã¨åŒã˜ï¼‰
          mkdir -p $HOME/www
          mkdir -p $HOME/www/assets/logo
          mkdir -p $HOME/www/functions/api
          mkdir -p $HOME/www/img/button
          mkdir -p $HOME/www/photos/main
          mkdir -p $HOME/www/photos/gallery
          cd $HOME/www
          echo "Current directory: `pwd`"
          
          # æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆåŸºæœ¬ç‰ˆã¨åŒã˜ï¼‰
          if ( -f "index.html" ) then
            echo "Backing up existing files..."
            mkdir -p $HOME/backup
            cp *.html $HOME/backup/ >& /dev/null
            cp *.css $HOME/backup/ >& /dev/null
          endif
          
          echo "ðŸ“¥ Downloading files from GitHub..."
          
          # åŸºæœ¬ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆæˆåŠŸç‰ˆã¨åŒã˜ï¼‰
          echo "ðŸ“„ Downloading core files..."
          fetch -q -o index.html https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/index.html || curl -s -o index.html https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/index.html
          fetch -q -o about.html https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/about.html || curl -s -o about.html https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/about.html
          fetch -q -o style.css https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/style.css || curl -s -o style.css https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/style.css
          fetch -q -o tankadb.csv https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/tankadb.csv || curl -s -o tankadb.csv https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/tankadb.csv
          fetch -q -o README.md https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/README.md || curl -s -o README.md https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/README.md
          
          # è¿½åŠ ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ - ã‚¨ãƒ©ãƒ¼ã§ã‚‚ç¶šè¡Œï¼‰
          echo "ðŸ“œ Downloading additional files..."
          fetch -q -o tanka-votes.csv https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/tanka-votes.csv >& /dev/null || curl -s -o tanka-votes.csv https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/tanka-votes.csv >& /dev/null || echo "tanka-votes.csv not found (OK)"
          fetch -q -o tii-database.json https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/tii-database.json >& /dev/null || curl -s -o tii-database.json https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/tii-database.json >& /dev/null || echo "tii-database.json not found (OK)"
          fetch -q -o wrangler.toml https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/wrangler.toml >& /dev/null || curl -s -o wrangler.toml https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/wrangler.toml >& /dev/null || echo "wrangler.toml not found (OK)"
          fetch -q -o _headers https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/_headers >& /dev/null || curl -s -o _headers https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/_headers >& /dev/null || echo "_headers not found (OK)"
          fetch -q -o _redirects https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/_redirects >& /dev/null || curl -s -o _redirects https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/_redirects >& /dev/null || echo "_redirects not found (OK)"
          fetch -q -o CNAME https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/CNAME >& /dev/null || curl -s -o CNAME https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/CNAME >& /dev/null || echo "CNAME not found (OK)"
          
          # JavaScript ãƒ•ã‚¡ã‚¤ãƒ«
          echo "ðŸ—‚ï¸ Downloading JavaScript files..."
          fetch -q -o photo-manager.js https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/photo-manager.js >& /dev/null || curl -s -o photo-manager.js https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/photo-manager.js >& /dev/null || echo "photo-manager.js not found (OK)"
          fetch -q -o tanka-system.js https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/tanka-system.js >& /dev/null || curl -s -o tanka-system.js https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/tanka-system.js >& /dev/null || echo "tanka-system.js not found (OK)"
          fetch -q -o notion-api.js https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/notion-api.js >& /dev/null || curl -s -o notion-api.js https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/notion-api.js >& /dev/null || echo "notion-api.js not found (OK)"
          
          # PHP ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆå®Œå…¨ã«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
          echo "ðŸ”§ Downloading PHP files (optional)..."
          fetch -q -o .htaccess https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/.htaccess >& /dev/null || curl -s -o .htaccess https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/.htaccess >& /dev/null || echo ".htaccess not found (will continue without PHP features)"
          fetch -q -o photo-admin.php https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/photo-admin.php >& /dev/null || curl -s -o photo-admin.php https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/photo-admin.php >& /dev/null || echo "photo-admin.php not found (will continue without PHP features)"
          fetch -q -o update-photo-list.php https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/update-photo-list.php >& /dev/null || curl -s -o update-photo-list.php https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/update-photo-list.php >& /dev/null || echo "update-photo-list.php not found (will continue without PHP features)"
          
          # ã‚µãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆã‚¨ãƒ©ãƒ¼ã§ã‚‚ç¶šè¡Œï¼‰
          echo "ðŸ“ Downloading subdirectory files..."
          cd functions/api
          fetch -q -o flickr-photos.js https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/functions/api/flickr-photos.js >& /dev/null || curl -s -o flickr-photos.js https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/functions/api/flickr-photos.js >& /dev/null || echo "flickr-photos.js not found (OK)"
          fetch -q -o tii-entries.js https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/functions/api/tii-entries.js >& /dev/null || curl -s -o tii-entries.js https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/functions/api/tii-entries.js >& /dev/null || echo "tii-entries.js not found (OK)"
          fetch -q -o tanka-vote.js https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/functions/api/tanka-vote.js >& /dev/null || curl -s -o tanka-vote.js https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/functions/api/tanka-vote.js >& /dev/null || echo "tanka-vote.js not found (OK)"
          cd ../..
          
          cd assets/logo
          fetch -q -o logo.png https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/assets/logo/logo.png >& /dev/null || curl -s -o logo.png https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/assets/logo/logo.png >& /dev/null || echo "logo.png not found (OK)"
          cd ../..
          
          cd img/button
          fetch -q -o maps.png https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/img/button/maps.png >& /dev/null || curl -s -o maps.png https://raw.githubusercontent.com/sogoodsnet/sogoods.net-www/main/img/button/maps.png >& /dev/null || echo "maps.png not found (OK)"
          cd ../..
          
          # ãƒ•ã‚¡ã‚¤ãƒ«æ¨©é™è¨­å®šï¼ˆåŸºæœ¬ç‰ˆã¨åŒã˜ï¼‰
          chmod 644 *.html *.css *.md >& /dev/null
          chmod 644 *.csv *.json >& /dev/null
          chmod 644 *.js >& /dev/null
          chmod 644 *.php >& /dev/null
          chmod 755 .
          
          # çµæžœç¢ºèª
          echo "ðŸ“‹ Deployed files:"
          ls -la
          
          # ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ç¢ºèª
          echo "ðŸ“„ index.html first line:"
          head -1 index.html >& /dev/null && echo "index.html found" || echo "index.html not found"
          
          echo "âœ… Complete deployment completed!"
          
    - name: Test Website Access
      run: |
        echo "ðŸŒ Testing website access..."
        sleep 10
        
        # HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
        STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://sogoodsnet.sakura.ne.jp/ || echo "000")
        echo "HTTP Status: $STATUS"
        
        if [ "$STATUS" = "200" ]; then
          echo "âœ… Website is accessible!"
        else
          echo "âš ï¸ Website may not be accessible yet (Status: $STATUS)"
        fi
        
    - name: Deployment Summary
      if: always()
      run: |
        echo "## ðŸš€ Complete Website Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ job.status }}" == "success" ]; then
          echo "- **Status**: âœ… Success" >> $GITHUB_STEP_SUMMARY
          echo "- **Method**: Complete file sync from GitHub" >> $GITHUB_STEP_SUMMARY
          echo "- **Files**: Core + Additional features deployed" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **Status**: âŒ Failed" >> $GITHUB_STEP_SUMMARY
          echo "- **Check**: SSH connection, file downloads, or permissions" >> $GITHUB_STEP_SUMMARY
        fi
        echo "- **Server**: FreeBSD Sakura VPS" >> $GITHUB_STEP_SUMMARY
        echo "- **URL**: ðŸŒ [https://sogoodsnet.sakura.ne.jp/](https://sogoodsnet.sakura.ne.jp/)" >> $GITHUB_STEP_SUMMARY
