name: Deploy to Sakura Server (Debug)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  debug-ssh-connection:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Debug SSH Key
      run: |
        echo "ðŸ” SSHéµã®ç¢ºèª..."
        echo "SSH_PRIVATE_KEY ã®æœ€åˆã®æ•°æ–‡å­—:"
        echo "${{ secrets.SSH_PRIVATE_KEY }}" | head -c 50
        echo "..."
        
        echo "SSH_PRIVATE_KEY ã®é•·ã•:"
        echo "${{ secrets.SSH_PRIVATE_KEY }}" | wc -c
        
    - name: Test SSH Connection
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: sogoodsnet.sakura.ne.jp
        username: sogoodsnet
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        debug: true
        script: |
          echo "ðŸŽ‰ SSHæŽ¥ç¶šæˆåŠŸ!"
          echo "ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼: $(whoami)"
          echo "ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: $(pwd)"
          echo "ãƒ›ãƒ¼ãƒ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å†…å®¹:"
          ls -la ~/
          
          echo "SSHè¨­å®šã®ç¢ºèª:"
          ls -la ~/.ssh/ 2>/dev/null || echo "~/.ssh ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“"
          
          echo "wwwãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ç¢ºèª:"
          if [ -d "/home/sogoodsnet/www" ]; then
            echo "âœ… /home/sogoodsnet/www å­˜åœ¨ã—ã¾ã™"
            ls -la /home/sogoodsnet/www/
          else
            echo "âš ï¸ /home/sogoodsnet/www ãŒå­˜åœ¨ã—ã¾ã›ã‚“"
            echo "ðŸ”§ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆä¸­..."
            mkdir -p /home/sogoodsnet/www
            echo "âœ… ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¾ã—ãŸ"
          fi
          
          echo "Gitè¨­å®šã®ç¢ºèª:"
          which git && git --version || echo "GitãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“"
          
  deploy-to-sakura:
    runs-on: ubuntu-latest
    needs: debug-ssh-connection
    if: success()
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Prepare deployment files
      run: |
        echo "ðŸŽ¯ Preparing files for Sakura server deployment..."
        
        # é–‹ç™ºç”¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é™¤å¤–
        rm -f AGENT.md deploy-server.sh webhook-deploy.php test_*.sh *.yml 2>/dev/null || true
        rm -rf .github temp_workflows 2>/dev/null || true
        
        # ãƒ‡ãƒ—ãƒ­ã‚¤ç”¨ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆ
        echo "ðŸ“¦ Files to deploy:"
        find . -maxdepth 1 -type f \( -name "*.html" -o -name "*.css" -o -name "*.js" -o -name "README.md" -o -name "DEPLOYMENT.md" -o -name "GITHUB_ACTIONS.md" -o -name "SAKURA_DEPLOY.md" \) -exec ls -la {} \;
        
    - name: Deploy via SSH to Sakura
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: sogoodsnet.sakura.ne.jp
        username: sogoodsnet  
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        script: |
          echo "ðŸš€ Starting deployment on Sakura server..."
          
          # ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
          DEPLOY_PATH="/home/sogoodsnet/www"
          BACKUP_PATH="/home/sogoodsnet/backup/sogoods-backup-$(date +%Y%m%d-%H%M%S)"
          
          echo "ðŸ“‚ Deploy path: $DEPLOY_PATH"
          echo "ðŸ’¾ Backup path: $BACKUP_PATH"
          
          # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ
          mkdir -p "/home/sogoodsnet/backup"
          
          # æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
          if [ -d "$DEPLOY_PATH" ] && [ "$(ls -A $DEPLOY_PATH 2>/dev/null)" ]; then
            echo "ðŸ“¦ Creating backup..."
            mkdir -p "$BACKUP_PATH"
            cp -r "$DEPLOY_PATH"/* "$BACKUP_PATH/" 2>/dev/null || true
            echo "âœ… Backup created at: $BACKUP_PATH"
          fi
          
          # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æº–å‚™
          mkdir -p "$DEPLOY_PATH"
          cd "$DEPLOY_PATH"
          
          # Git repository setup
          if [ ! -d ".git" ]; then
            echo "ðŸ”„ Initializing git repository..."
            git init
            git remote add origin https://github.com/sogoodsnet/sogoods.net-www.git
          fi
          
          # æœ€æ–°ã‚³ãƒ¼ãƒ‰ã®å–å¾—
          echo "ðŸ“¥ Fetching latest code from GitHub..."
          git fetch origin main 2>&1 || echo "Git fetch failed, trying alternative..."
          git reset --hard origin/main 2>&1 || echo "Git reset failed, continuing..."
          
          # ä¸è¦ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤
          echo "ðŸ§¹ Cleaning up development files..."
          rm -rf .git .github AGENT.md deploy-server.sh webhook-deploy.php temp_workflows test_*.sh *.yml 2>/dev/null || true
          
          # ãƒ•ã‚¡ã‚¤ãƒ«æ¨©é™ã®è¨­å®š
          echo "ðŸ”§ Setting file permissions..."
          find . -type f -name "*.html" -exec chmod 644 {} \; 2>/dev/null || true
          find . -type f -name "*.css" -exec chmod 644 {} \; 2>/dev/null || true
          find . -type f -name "*.js" -exec chmod 644 {} \; 2>/dev/null || true
          find . -type f -name "*.md" -exec chmod 644 {} \; 2>/dev/null || true
          find . -type d -exec chmod 755 {} \; 2>/dev/null || true
          
          # ãƒ‡ãƒ—ãƒ­ã‚¤çµæžœã®ç¢ºèª
          echo "ðŸ“‹ Deployed files:"
          ls -la
          
          echo "âœ… Deployment completed successfully!"
          echo "ðŸŒ Site should be available at https://sogoodsnet.sakura.ne.jp/"
          
    - name: Deployment Summary
      if: always()
      run: |
        echo "## ðŸš€ Sakura Server Deployment Summary (Debug)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ job.status }}" == "success" ]; then
          echo "- **Status**: âœ… Success" >> $GITHUB_STEP_SUMMARY
          echo "- **SSH Connection**: âœ… Working" >> $GITHUB_STEP_SUMMARY
          echo "- **Server**: sogoodsnet.sakura.ne.jp" >> $GITHUB_STEP_SUMMARY
          echo "- **Deploy Path**: /home/sogoodsnet/www" >> $GITHUB_STEP_SUMMARY
          echo "- **Deploy Time**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **Backup Created**: Yes (in /home/sogoodsnet/backup/)" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **Status**: âŒ Failed" >> $GITHUB_STEP_SUMMARY
          echo "- **Check**: SSH connection and key configuration" >> $GITHUB_STEP_SUMMARY
        fi
